<!DOCTYPE html><html class="theme-lattice"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>一个学习 Koa 源码的例子 | Aotu.io「凹凸实验室」</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="凹凸实验室"><meta name="designer" content="凹凸实验室"><meta name="rating" content="general"><meta name="format-detection" content="telephone=yes"><meta name="robots" content="index, follow"><meta baidu-gxt-verify-token="2b74a5aea155a215abea8547f929190c"><meta name="keywords" content="文件上传,凹凸实验室,Aotu,前端开发,全栈开发,IOS开发,Android开发"><link rel="canonical" href="https://aotu.io/notes/2020/05/18/koa-demo/index.html"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon-48x48.png"><link rel="manifest" href="/img/manifest.json"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#2f83cd"><meta name="application-name" content="Aotu.io"><link rel="apple-touch-icon" sizes="57x57" href="/img/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/img/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/img/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/img/apple-touch-icon-1024x1024.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Aotu.io"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/img/mstile-144x144.png"><meta name="msapplication-config" content="/img/browserconfig.xml"><meta property="wb:webmaster" content="a1686eb81db284d5"><link rel="dns-prefetch" href="//storage.360buyimg.com"><link rel="dns-prefetch" href="//img10.360buyimg.com"><link rel="dns-prefetch" href="//img11.360buyimg.com"><link rel="dns-prefetch" href="//img12.360buyimg.com"><link rel="dns-prefetch" href="//img13.360buyimg.com"><link rel="dns-prefetch" href="//img14.360buyimg.com"><link rel="dns-prefetch" href="//img20.360buyimg.com"><link rel="dns-prefetch" href="//img30.360buyimg.com"><link rel="dns-prefetch" href="//misc.aotu.io"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" href="/atom.xml" title="Aotu.io"><meta name="description" content="「Moa」一个学习 Koa 源码的例子 学习目标：  原生 node 封装 中间件 路由 静态文件服务（未完成待续）   Koa 原理一个 nodejs 的入门级 http 服务代码如下，12345678910// index.jsconst http = require(&apos;http&apos;)const server = http.createServer((req, res) =&amp;gt; &amp;#123;"><meta name="keywords" content="文件上传"><meta property="og:type" content="article"><meta property="og:title" content="一个学习 Koa 源码的例子"><meta property="og:url" content="https://aotu.io/notes/2020/05/18/koa-demo/index.html"><meta property="og:site_name" content="Aotu.io"><meta property="og:description" content="「Moa」一个学习 Koa 源码的例子 学习目标：  原生 node 封装 中间件 路由 静态文件服务（未完成待续）   Koa 原理一个 nodejs 的入门级 http 服务代码如下，12345678910// index.jsconst http = require(&apos;http&apos;)const server = http.createServer((req, res) =&amp;gt; &amp;#123;"><meta property="og:locale" content="zh-cn"><meta property="og:image" content="https://aotu.io/static/onion.jpeg"><meta property="og:image" content="https://aotu.io/static/table.jpeg"><meta property="og:updated_time" content="2021-02-02T07:48:05.250Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="一个学习 Koa 源码的例子"><meta name="twitter:description" content="「Moa」一个学习 Koa 源码的例子 学习目标：  原生 node 封装 中间件 路由 静态文件服务（未完成待续）   Koa 原理一个 nodejs 的入门级 http 服务代码如下，12345678910// index.jsconst http = require(&apos;http&apos;)const server = http.createServer((req, res) =&amp;gt; &amp;#123;"><meta name="twitter:image" content="https://aotu.io/static/onion.jpeg"><meta name="twitter:site" content="o2circle"><script>var App={root:"/",isHome:!1,isCate:!1,isTag:!1}</script></head><body class="page-post-detail"><div class="mod-hd"><div class="grid"><div class="mod-logo"><a href="/index.html" title="Aotu.io">Aotu.io</a></div><span class="mod-hd-toggle" id="J_hdToggle"><i class="fa fa-bars"></i></span><div class="mod-hd-main"><div class="mod-hd-inner"><nav class="mod-nav"><ul class="mod-nav-list"><li class="main-nav-item"><a href="/index.html" class="main-nav-link">首页</a></li><li class="main-nav-item"><a target="_blank" href="https://geeks.aotu.io" class="main-nav-link">极客沙龙</a></li><li class="main-nav-item"><a href="https://cases.aotu.io" class="main-nav-link">H5案例</a></li><li class="main-nav-item"><a href="/about/" class="main-nav-link">关于</a></li><li class="main-nav-item"><a href="/join/" class="main-nav-link">加入我们</a></li></ul></nav><div class="mod-search" id="J_search"><a class="fa fa-search mod-search-ico" id="J_searchTrigger" title="搜索"></a><form id="J_searchForm" method="get" class="mod-search-form" action="/search/"><input type="text" name="query" class="mod-search-ipt" id="J_searchInput" placeholder="搜索"></form></div></div></div></div></div><div class="mod-container"><div class="grid"><div class="mod-main typo"><article class="post"><div class="post-cover"><img src="http://img11.360buyimg.com/ling/jfs/t1/126280/27/2248/145305/5ec3a5d5E31e3d95e/e86091761fffe47b.jpg" alt="一个学习 Koa 源码的例子"></div><header class="post-hd"><h1 class="post-tit">一个学习 Koa 源码的例子</h1><div class="post-meta">by <a target="_blank" href="https://github.com/marklin2012" class="post-author">marklin</a> on <span>2020-05-19</span></div><p class="post-subtit" style="display:none"><i class="fa fa-quote-left"></i>一个例子带你了解 Koa</p><span style="display:none" id="busuanzi_value_page_pv"></span></header><div class="post-content"><h1 id="「Moa」一个学习-Koa-源码的例子" class="post-heading"><a href="#「Moa」一个学习-Koa-源码的例子" class="headerlink" title="「Moa」一个学习 Koa 源码的例子"></a>「Moa」一个学习 Koa 源码的例子<a class="post-anchor" href="#「Moa」一个学习-Koa-源码的例子" aria-hidden="true"></a></h1><blockquote><p>学习目标：</p><ol><li>原生 node 封装</li><li>中间件</li><li>路由</li><li>静态文件服务（未完成待续）</li></ol></blockquote><h3 id="Koa-原理" class="post-heading"><a href="#Koa-原理" class="headerlink" title="Koa 原理"></a>Koa 原理<a class="post-anchor" href="#Koa-原理" aria-hidden="true"></a></h3><p>一个 <em>nodejs</em> 的入门级 <em>http</em> 服务代码如下，<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>)</span><br><span class="line">  res.end(<span class="string">'hello nodejs'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server started at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p><em>koa</em> 的目标是更简单化、流程化、模块化的方式实现回调，我们希望可以参照 <em>koa</em> 用如下方式来实现代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> Moa = <span class="built_in">require</span>(<span class="string">'./moa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Moa()</span><br><span class="line"></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.writeHeader(<span class="number">200</span>)</span><br><span class="line">  res.end(<span class="string">'hello, Moa'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server started at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>所以我们需要创建一个 <code>moa.js</code> 文件，该文件主要内容是创建一个类 <em>Moa</em>， 主要包含 <code>use()</code> 和 <code>listen()</code> 两个方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 moa.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Moa</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  use(callback) &#123;</span><br><span class="line">    <span class="keyword">this</span>.callback = callback</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  listen(...args) &#123;</span><br><span class="line">    <span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.callback(req, res)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    server.listen(...args)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Moa</span><br></pre></td></tr></table></figure><h3 id="Context" class="post-heading"><a href="#Context" class="headerlink" title="Context"></a>Context<a class="post-anchor" href="#Context" aria-hidden="true"></a></h3><p><em>koa</em> 为了能够简化 API，引入了上下文 <em>context</em> 的概念，将原始的请求对象 <em>req</em> 和响应对象 <em>res</em> 封装并挂载到了 <em>context</em> 上，并且设置了 <em>getter</em> 和 <em>setter</em> ，从而简化操作</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app.use((req, res) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//   res.writeHeader(200)</span></span><br><span class="line"><span class="comment">//   res.end('hello, Moa')</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">  ctx.body = <span class="string">'cool moa'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>为了达到上面代码的效果，我们需要分装 3 个类，分别是 <code>context</code>, <code>request</code>, <code>response</code> , 同时分别创建上述 3 个 js 文件，</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="keyword">get</span> url() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.req.url</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> method() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.req.method.toLowerCase()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// response.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="keyword">get</span> body() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._body</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> body(val) = &#123;</span><br><span class="line">    <span class="keyword">this</span>._body = val</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// context.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="keyword">get</span> url() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.request.url</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> body() = &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.response.body</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> body(val) &#123;</span><br><span class="line">    <span class="keyword">this</span>.response.body = val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> method() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.request.method</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着我们需要给 <em>Moa</em> 这个类添加一个 <code>createContext(req, res)</code> 的方法, 并在 <code>listen()</code> 方法中适当的地方挂载上：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// moa.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> context = <span class="built_in">require</span>(<span class="string">'./context'</span>)</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'./request'</span>)</span><br><span class="line"><span class="keyword">const</span> response = <span class="built_in">require</span>(<span class="string">'./response'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Moa</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  listen(...args) &#123;</span><br><span class="line">    <span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 创建上下文</span></span><br><span class="line">      <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.callback(ctx)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 响应</span></span><br><span class="line">      res.end(ctx.body)</span><br><span class="line">    &#125;)</span><br><span class="line">    server.listen(...args)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  createContext(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="built_in">Object</span>.create(context)</span><br><span class="line">    ctx.request = <span class="built_in">Object</span>.create(request)</span><br><span class="line">    ctx.response = <span class="built_in">Object</span>.create(response)</span><br><span class="line"></span><br><span class="line">    ctx.req = ctx.request.req = req</span><br><span class="line">    ctx.res = ctx.response.res = res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="中间件" class="post-heading"><a href="#中间件" class="headerlink" title="中间件"></a>中间件<a class="post-anchor" href="#中间件" aria-hidden="true"></a></h3><p><em>Koa</em> 中间键机制：<em>Koa</em> 中间件机制就是函数组合的概念，将一组需要顺序执行的函数复合为一个函数，外层函数的参数实际是内层函数的返回值。洋葱圈模型可以形象表示这种机制，是 <code>Koa</code> 源码中的精髓和难点。</p><p><img src="/static/onion.jpeg" alt="洋葱圈模型"></p><h4 id="同步函数组合" class="post-heading"><a href="#同步函数组合" class="headerlink" title="同步函数组合"></a>同步函数组合<a class="post-anchor" href="#同步函数组合" aria-hidden="true"></a></h4><p>假设有 3 个同步函数:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose_test.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn1'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn1 end'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn2'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn2 end'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn3'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn3 end'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们如果想把三个函数组合成一个函数且按照顺序来执行，那通常的做法是这样的：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose_test.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">fn3(fn2(fn1()))</span><br></pre></td></tr></table></figure><p>执行 <code>node compose_test.js</code> 输出结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fn1</span><br><span class="line">fn1 end</span><br><span class="line">fn2</span><br><span class="line">fn2 end</span><br><span class="line">fn3</span><br><span class="line">fn3 end</span><br></pre></td></tr></table></figure><p>当然这不能叫做是函数组合，我们期望的应该是需要一个 <code>compose()</code> 方法来帮我们进行函数组合，按如下形式来编写代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose_test.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> middlewares = [fn1, fn2, fn3]</span><br><span class="line"><span class="keyword">const</span> finalFn = compose(middlewares)</span><br><span class="line">finalFn()</span><br></pre></td></tr></table></figure><p>让我们来实现一下 <code>compose()</code> 函数，<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose_test.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> compose = <span class="function">(<span class="params">middlewares</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  [first, ...others] = middlewares</span><br><span class="line">  <span class="keyword">let</span> ret = first()</span><br><span class="line">  others.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">    ret = fn(ret)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> middlewares = [fn1, fn2, fn3]</span><br><span class="line"><span class="keyword">const</span> finalFn = compose(middlewares)</span><br><span class="line">finalFn()</span><br></pre></td></tr></table></figure><p></p><p>可以看到我们最终得到了期望的输出结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fn1</span><br><span class="line">fn1 end</span><br><span class="line">fn2</span><br><span class="line">fn2 end</span><br><span class="line">fn3</span><br><span class="line">fn3 end</span><br></pre></td></tr></table></figure><h4 id="异步函数组合" class="post-heading"><a href="#异步函数组合" class="headerlink" title="异步函数组合"></a>异步函数组合<a class="post-anchor" href="#异步函数组合" aria-hidden="true"></a></h4><p>了解了同步的函数组合后，我们在中间件中的实际场景其实都是异步的，所以我们接着来研究下异步函数组合是如何进行的，首先我们改造一下刚才的同步函数，使他们变成异步函数,</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose_test.js</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn1</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn1'</span>)</span><br><span class="line">  next &amp;&amp; <span class="keyword">await</span> next()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn1 end'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn2</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn2'</span>)</span><br><span class="line">  next &amp;&amp; <span class="keyword">await</span> next()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn2 end'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn3</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn3'</span>)</span><br><span class="line">  next &amp;&amp; <span class="keyword">await</span> next()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'fn3 end'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>现在我们期望的输出结果是这样的:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fn1</span><br><span class="line">fn2</span><br><span class="line">fn3</span><br><span class="line">fn3 end</span><br><span class="line">fn2 end</span><br><span class="line">fn1 end</span><br></pre></td></tr></table></figure><p>同时我们希望编写代码的方式也不要改变,</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose_test.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> middlewares = [fn1, fn2, fn3]</span><br><span class="line"><span class="keyword">const</span> finalFn = compose(middlewares)</span><br><span class="line">finalFn()</span><br></pre></td></tr></table></figure><p>所以我们只需要改造一下 <code>compose()</code> 函数，使他支持异步函数就即可:<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose_test.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">middlewares</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch(<span class="number">0</span>)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> fn = middlewares[i]</span><br><span class="line">      <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(</span><br><span class="line">        fn(<span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> dispatch(i + <span class="number">1</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> middlewares = [fn1, fn2, fn3]</span><br><span class="line"><span class="keyword">const</span> finalFn = compose(middlewares)</span><br><span class="line">finalFn()</span><br></pre></td></tr></table></figure><p></p><p>运行结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fn1</span><br><span class="line">fn2</span><br><span class="line">fn3</span><br><span class="line">fn3 end</span><br><span class="line">fn2 end</span><br><span class="line">fn1 end</span><br></pre></td></tr></table></figure><p>完美！！！</p><h4 id="完善-Moa" class="post-heading"><a href="#完善-Moa" class="headerlink" title="完善 Moa"></a>完善 Moa<a class="post-anchor" href="#完善-Moa" aria-hidden="true"></a></h4><p>我们直接把刚才的异步合成代码移植到 <code>moa.js</code> 中, 由于 <em>koa</em> 中还需要用到 <code>ctx</code> 字段，所以我们还要对 <code>compose()</code> 方法进行一些改造才能使用：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// moa.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Moa</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  compose(middlewares) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> dispatch(<span class="number">0</span>)</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> fn = middlewares[i]</span><br><span class="line">        <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(</span><br><span class="line">          fn(ctx, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> dispatch(i + <span class="number">1</span>)</span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现完 <code>compose()</code> 方法之后我们继续完善我们的代码，首先我们需要给类在构造的时候，添加一个 <code>middlewares</code>，用来记录所有需要进行组合的函数，接着在<code>use()</code> 方法中把我们每一次调用的回调都记录一下，保存到<code>middlewares</code> 中，最后再在合适的地方调用即可：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// moa.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Moa</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.middlewares = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  use(middleware) &#123;</span><br><span class="line">    <span class="keyword">this</span>.middlewares.push(middleware)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  listen(...args) &#123;</span><br><span class="line">    <span class="keyword">const</span> server = http.createServer(<span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 创建上下文</span></span><br><span class="line">      <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res)</span><br><span class="line">      <span class="keyword">const</span> fn = <span class="keyword">this</span>.compose(<span class="keyword">this</span>.middlewares)</span><br><span class="line">      <span class="keyword">await</span> fn(ctx)</span><br><span class="line">      <span class="comment">// 响应</span></span><br><span class="line">      res.end(ctx.body)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    server.listen(...args)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们加一小段代码测试一下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">const</span> delay = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve()</span><br><span class="line">  , <span class="number">2000</span>))</span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">"1"</span></span><br><span class="line">  <span class="keyword">await</span> next()</span><br><span class="line">  ctx.body += <span class="string">"5"</span></span><br><span class="line">&#125;)</span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.body += <span class="string">"2"</span></span><br><span class="line">  <span class="keyword">await</span> delay()</span><br><span class="line">  <span class="keyword">await</span> next()</span><br><span class="line">  ctx.body += <span class="string">"4"</span></span><br><span class="line">&#125;)</span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.body += <span class="string">"3"</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>运行命令 <code>node index.js</code> 启动服务器后，我们访问页面 <code>localhost:3000</code> 查看一下，发现页面显示 <code>12345</code> ！</p><p>到此，我们简版的 <code>Koa</code> 就已经完成实现了。让我们庆祝一下先！！！</p><h3 id="Router" class="post-heading"><a href="#Router" class="headerlink" title="Router"></a>Router<a class="post-anchor" href="#Router" aria-hidden="true"></a></h3><p><code>Koa</code> 还有一个很重要的路由功能，感觉缺少路由就缺少了他的完整性，所以我们简单介绍下如何实现路由功能。</p><p>其实，路由的原理就是根据地址和方法，调用相对应的函数即可，其核心就是要利用一张表，记录下注册的路由和方法，原理图如下所示：</p><p><img src="/static/table.jpeg" alt="路由原理"></p><p>使用方式如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'./router'</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router()</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="keyword">async</span> ctx =&gt; &#123; ctx.body = <span class="string">'index page'</span> &#125;)</span><br><span class="line">router.get(<span class="string">'/home'</span>, <span class="keyword">async</span> ctx =&gt; &#123; ctx.body = <span class="string">'home page'</span> &#125;)</span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="keyword">async</span> ctx =&gt; &#123; ctx.body = <span class="string">'post index'</span> &#125;)</span><br><span class="line">app.use(router.routes())</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>我们来实现下 <code>router</code> 这个类，先在根目录创建一个 <code>router.js</code> 文件，然后根据路由的原理，我们实现下代码:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.stacks = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  register(path, method, middleware) &#123;</span><br><span class="line">    <span class="keyword">this</span>.stacks.push(&#123;</span><br><span class="line">      path, method, middleware</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span>(path, middleware) &#123;</span><br><span class="line">    <span class="keyword">this</span>.register(path, <span class="string">'get'</span>, middleware)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  post(path, middleware) &#123;</span><br><span class="line">    <span class="keyword">this</span>.register(path, <span class="string">'post'</span>, middleware)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  routes() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> url = ctx.url === <span class="string">'/index'</span> ? <span class="string">'/'</span> : ctx.url</span><br><span class="line">      <span class="keyword">let</span> method = ctx.method</span><br><span class="line">      <span class="keyword">let</span> route</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.stacks.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> item = <span class="keyword">this</span>.stacks[i]</span><br><span class="line">        <span class="keyword">if</span> (item.path === url &amp;&amp; item.method === method) &#123;</span><br><span class="line">          route = item.middleware</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> route === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> route(ctx, next)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> next()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Router</span><br></pre></td></tr></table></figure><p>启动服务器后，测试下 <code>loacalhost:3000</code>, 返回页面上 <code>index page</code> 表示路由实现成功！</p><div class="post-tags" style="display:none"><a href="/tags/文件上传/">文件上传</a></div><div class="post-categories" style="display:none"><a href="/cates/全栈开发/">全栈开发</a></div><div class="post-announce">感谢您的阅读，本文由 <a href="//aotu.io">凹凸实验室</a> 版权所有。如若转载，请注明出处：凹凸实验室（<a href="https://aotu.io/notes/2020/05/18/koa-demo/">https://aotu.io/notes/2020/05/18/koa-demo/</a>）</div><div class="post-revision"><i class="fa fa-clock-o"></i> <time class="post-updated" datetime="2021-02-02T07:48:05.250Z">上次更新：2021-02-02 15:48:05</time></div></div><div class="post-nav"><div class="post-nav-next"><a href="/notes/2020/05/25/taro-3-rc/" title="Taro 3.0 RC：React/Vue/Nerv 任你选">Taro 3.0 RC：React/Vue/Nerv 任你选 <i class="fa fa-chevron-right"></i></a></div><div class="post-nav-prev"><a href="/notes/2020/05/12/file-upload/" title="大规格文件的上传优化"><i class="fa fa-chevron-left"></i> 大规格文件的上传优化</a></div></div><div class="post-comments" id="comments"></div><script>var gitalkOpts={id:"bm90ZXMvMjAyMC8wNS8xOC9rb2EtZGVtby8=",owner:"o2team",repo:"o2team.github.io",title:"一个学习 Koa 源码的例子",body:"https://aotu.io/notes/2020/05/18/koa-demo/index.html\n\n一个例子带你了解 Koa",clientID:"3c4d153e6874260f9c7e",clientSecret:"dd44012504c6168bc05b9266e0554bb28c62ce15",admin:["marklin2012"]}</script></article></div><aside class="mod-side" id="sidebar"><div class="mod-side-sec aotuwx"><img class="aotuwx-qrcode" src="/img/qrcode.jpg" alt="关注我们"><div class="aotuwx-slogan">每周推送精选技术文章</div></div><div class="mod-side-sec works"><div class="mod-side-sec-hd"><h2>服务/产品</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="//taro.jd.com" target="_blank" title="Taro">Taro</a></li><li><a href="//taro-ui.jd.com" target="_blank" title="Taro-UI">Taro-UI</a></li><li><a href="//taro-ext.jd.com" target="_blank" title="Taro 物料市场">Taro 物料市场</a></li><li><a href="//taro-club.jd.com" target="_blank" title="Taro 官方论坛">Taro 官方论坛</a></li><li><a href="//cases.aotu.io/mobi/maga.html" target="_blank" title="拇指期刊">拇指期刊</a></li><li><a href="//athena.aotu.io/" target="_blank" title="Athena">Athena</a></li><li><a href="//guide.aotu.io/" target="_blank" title="前端代码规范">前端代码规范</a></li><li><a href="//halojs.aotu.io/" target="_blank" title="HaloJS">HaloJS</a></li><li><a href="//sign.aotu.io/" target="_blank" title="邮件签名工具">邮件签名工具</a></li><li><a href="//mac.aotu.io/" target="_blank" title="MAC全栈环境">MAC全栈环境</a></li><li><a href="//xcel.aotu.io" target="_blank" title="Excel Filter">Excel Filter</a></li><li><a href="//aotu.jd.com/share/" target="_blank" title="凹凸公开课">凹凸公开课</a></li><li><a href="//at.aotu.io" target="_blank" title="AT-UI">AT-UI</a></li></ul></div></div><div class="mod-side-sec favlinks"><div class="mod-side-sec-hd"><h2>友情链接</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="https://www.cloudbase.net" target="_blank" title="小程序·云开发"><img style="width:22px;vertical-align:middle" src="https://img20.360buyimg.com/ling/jfs/t1/57175/5/15617/50216/5dca6729E00cdff5d/631622525425290e.png">小程序·云开发</a></li><li><a href="https://ling.jd.com" target="_blank" title="京东羚珑智能设计">羚珑智能设计</a></li><li><a href="https://jdrd.jd.com" target="_blank" title="京东零售设计服务平台">京东零售设计服务平台</a></li><li><a href="https://jdc.jd.com" target="_blank" title="京东设计中心">JDC京东设计中心</a></li><li><a href="http://dopro.io/" target="_blank" title="腾讯 Deep Ocean">Deep Ocean</a></li><li><a href="http://fex.baidu.com" target="_blank" title="百度Web前端研发部">百度FEX</a></li><li><a href="http://taobaofed.org" target="_blank" title="淘宝前端团队">淘宝FED</a></li><li><a href="http://tgideas.qq.com" target="_blank" title="腾讯互娱设计中心">TGIdeas</a></li><li><a href="http://isux.tencent.com" target="_blank" title="腾讯SNG设计中心">ISUX</a></li><li><a href="http://cdc.tencent.com" target="_blank" title="腾讯用户研究与体验设计中心">CDC</a></li><li><a href="http://ued.ctrip.com" target="_blank" title="携程设计委员会">携程UED</a></li><li><a href="https://uiiiuiii.com/" target="_blank" title="优优教程网">优优教程网</a></li><li><a href="https://www.designup.cn/" target="_blank" title="Designup">Designup</a></li><li><a href="http://eux.baidu.com/" target="_blank" title="百度EUX">百度EUX</a></li></ul></div></div></aside></div></div><div class="mod-backtop" id="backTop"><i class="fa fa-long-arrow-up"></i></div><footer class="mod-ft" id="footer"><div class="grid"><ul class="mod-ft-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="https://github.com/o2team/o2team.github.io" target="_blank"><i class="fa fa-github-alt"></i></a></li></ul><div class="mod-ft-sec mod-ft-copyright"><p>Designed by <a href="http://aotu.io" target="_blank">凹凸实验室</a> @<a target="_blank" href="http://jdc.jd.com">京东用户体验设计部</a></p><p>Copyright &copy; 2021. All Rights Reserved.</p><p><a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备15077732号-2</a></p></div></div></footer><script src="/js/bundle/core.js"></script><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/post_wx_share.js"></script><script src="/js/bundle/gitalk.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e850b980d029480b092fdd7503c3f8de";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript" src="https://tajs.qq.com/stats?sId=53685723" charset="UTF-8"></script></body></html>