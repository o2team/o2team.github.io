<!DOCTYPE html><html class="theme-lattice"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>京喜小程序首页瘦身实践 | Aotu.io「凹凸实验室」</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="凹凸实验室"><meta name="designer" content="凹凸实验室"><meta name="rating" content="general"><meta name="format-detection" content="telephone=yes"><meta name="robots" content="index, follow"><meta baidu-gxt-verify-token="2b74a5aea155a215abea8547f929190c"><meta name="keywords" content="小程序,性能优化,凹凸实验室,Aotu,前端开发,全栈开发,IOS开发,Android开发"><link rel="canonical" href="https://aotu.io/notes/2020/11/30/jx-code-slim/index.html"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon-48x48.png"><link rel="manifest" href="/img/manifest.json"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#2f83cd"><meta name="application-name" content="Aotu.io"><link rel="apple-touch-icon" sizes="57x57" href="/img/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/img/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/img/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/img/apple-touch-icon-1024x1024.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Aotu.io"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/img/mstile-144x144.png"><meta name="msapplication-config" content="/img/browserconfig.xml"><meta property="wb:webmaster" content="a1686eb81db284d5"><link rel="dns-prefetch" href="//storage.360buyimg.com"><link rel="dns-prefetch" href="//img10.360buyimg.com"><link rel="dns-prefetch" href="//img11.360buyimg.com"><link rel="dns-prefetch" href="//img12.360buyimg.com"><link rel="dns-prefetch" href="//img13.360buyimg.com"><link rel="dns-prefetch" href="//img14.360buyimg.com"><link rel="dns-prefetch" href="//img20.360buyimg.com"><link rel="dns-prefetch" href="//img30.360buyimg.com"><link rel="dns-prefetch" href="//misc.aotu.io"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" href="/atom.xml" title="Aotu.io"><meta name="description" content="前言在 web 开发场景，减少代码体积虽然是性能优化的一个方向，还没到锱铢必较的程度。但是在小程序场景，由于代码包上传阶段限制了主包 2M 和总包 16M（近期微信官方正在内测将总包上限调整至 20M ）的尺寸，超过就会面临无法发版的风险，代码包体积的优化就变得特别重要了。京喜小程序首页作为微信购物的大入口，承载大量流量，功能复杂模块众多，又要与其他核心业务和公共组件共享 2M 的主包空间，因此代"><meta name="keywords" content="性能优化,小程序"><meta property="og:type" content="article"><meta property="og:title" content="京喜小程序首页瘦身实践"><meta property="og:url" content="https://aotu.io/notes/2020/11/30/jx-code-slim/index.html"><meta property="og:site_name" content="Aotu.io"><meta property="og:description" content="前言在 web 开发场景，减少代码体积虽然是性能优化的一个方向，还没到锱铢必较的程度。但是在小程序场景，由于代码包上传阶段限制了主包 2M 和总包 16M（近期微信官方正在内测将总包上限调整至 20M ）的尺寸，超过就会面临无法发版的风险，代码包体积的优化就变得特别重要了。京喜小程序首页作为微信购物的大入口，承载大量流量，功能复杂模块众多，又要与其他核心业务和公共组件共享 2M 的主包空间，因此代"><meta property="og:locale" content="zh-cn"><meta property="og:image" content="https://img20.360buyimg.com/ling/jfs/t1/141980/32/15643/20505/5fbcd1b9E5ccc5e93/3e5b1e0b74f1beed.png"><meta property="og:image" content="https://img10.360buyimg.com/ling/jfs/t1/143666/20/16342/51366/5fc4aad2Ef0d502ce/bd7e1c8800de02e9.png"><meta property="og:image" content="https://img14.360buyimg.com/ling/jfs/t1/134362/18/17942/49773/5fc4aad6E13eb2362/37e0aa0a62bfcff5.png"><meta property="og:image" content="https://img13.360buyimg.com/ling/jfs/t1/129844/15/17945/49388/5fc4aadcEfccb1a95/27a4bf846553cac3.png"><meta property="og:image" content="https://img12.360buyimg.com/ling/jfs/t1/132774/6/17951/70297/5fc4ac4dEe9d95143/28fdb0be2cfeb56d.png"><meta property="og:image" content="https://img10.360buyimg.com/ling/jfs/t1/152190/14/7881/88282/5fc4ac33Ed0992ccd/ec17cab8c68050cb.png"><meta property="og:updated_time" content="2021-02-02T07:48:05.254Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="京喜小程序首页瘦身实践"><meta name="twitter:description" content="前言在 web 开发场景，减少代码体积虽然是性能优化的一个方向，还没到锱铢必较的程度。但是在小程序场景，由于代码包上传阶段限制了主包 2M 和总包 16M（近期微信官方正在内测将总包上限调整至 20M ）的尺寸，超过就会面临无法发版的风险，代码包体积的优化就变得特别重要了。京喜小程序首页作为微信购物的大入口，承载大量流量，功能复杂模块众多，又要与其他核心业务和公共组件共享 2M 的主包空间，因此代"><meta name="twitter:image" content="https://img20.360buyimg.com/ling/jfs/t1/141980/32/15643/20505/5fbcd1b9E5ccc5e93/3e5b1e0b74f1beed.png"><meta name="twitter:site" content="o2circle"><script>var App={root:"/",isHome:!1,isCate:!1,isTag:!1}</script></head><body class="page-post-detail"><div class="mod-hd"><div class="grid"><div class="mod-logo"><a href="/index.html" title="Aotu.io">Aotu.io</a></div><span class="mod-hd-toggle" id="J_hdToggle"><i class="fa fa-bars"></i></span><div class="mod-hd-main"><div class="mod-hd-inner"><nav class="mod-nav"><ul class="mod-nav-list"><li class="main-nav-item"><a href="/index.html" class="main-nav-link">首页</a></li><li class="main-nav-item"><a target="_blank" href="https://geeks.aotu.io" class="main-nav-link">极客沙龙</a></li><li class="main-nav-item"><a href="https://cases.aotu.io" class="main-nav-link">H5案例</a></li><li class="main-nav-item"><a href="/about/" class="main-nav-link">关于</a></li><li class="main-nav-item"><a href="/join/" class="main-nav-link">加入我们</a></li></ul></nav><div class="mod-search" id="J_search"><a class="fa fa-search mod-search-ico" id="J_searchTrigger" title="搜索"></a><form id="J_searchForm" method="get" class="mod-search-form" action="/search/"><input type="text" name="query" class="mod-search-ipt" id="J_searchInput" placeholder="搜索"></form></div></div></div></div></div><div class="mod-container"><div class="grid"><div class="mod-main typo"><article class="post"><div class="post-cover"><img src="https://img11.360buyimg.com/ling/jfs/t1/144096/16/15780/70671/5fbf9ea9Edb7ec722/10188639a8094a11.jpg" alt="京喜小程序首页瘦身实践"></div><header class="post-hd"><h1 class="post-tit">京喜小程序首页瘦身实践</h1><div class="post-meta">by <a target="_blank" href="https://github.com/Silencesnow" class="post-author">冥冥</a> on <span>2020-11-30</span></div><p class="post-subtit" style="display:none"><i class="fa fa-quote-left"></i>给小程序再减重30%的秘密</p><span style="display:none" id="busuanzi_value_page_pv"></span></header><div class="post-content"><h2 id="前言" class="post-heading"><a href="#前言" class="headerlink" title="前言"></a>前言<a class="post-anchor" href="#前言" aria-hidden="true"></a></h2><p>在 web 开发场景，减少代码体积虽然是性能优化的一个方向，还没到锱铢必较的程度。但是在小程序场景，由于代码包上传阶段限制了主包 2M 和总包 16M（近期微信官方正在内测将总包上限调整至 20M ）的尺寸，超过就会面临无法发版的风险，代码包体积的优化就变得特别重要了。<br>京喜小程序首页作为微信购物的大入口，承载大量流量，功能复杂模块众多，又要与其他核心业务和公共组件共享 2M 的主包空间，因此代码包瘦身的工作在持续不断进行，否则无法满足业务的快速增长。本文将结合以往优化策略与最近一次的瘦身实践，分享小程序代码瘦身的经验与思考。</p><h2 id="常见的瘦身方式" class="post-heading"><a href="#常见的瘦身方式" class="headerlink" title="常见的瘦身方式"></a>常见的瘦身方式<a class="post-anchor" href="#常见的瘦身方式" aria-hidden="true"></a></h2><p>京喜首页项目是一个优化良好的项目，对于常见的优化措施，已经有过很好的实践，就让我们我们先回顾一下有哪些常见的优化策略吧：</p><ol><li><p>代码分包：将相对独立的页面和组件拆分到分包，可以解决主包体积受限问题；</p></li><li><p>依赖分析：移除未引用的页面、组件和其他文件；</p></li><li><p>避免使用本地资源：除了兜底图片，其他都尽可能使用 url 的方式，由于 base64 图本质上是将信息编码成长字符串，也会占用很多空间，不建议使用；</p></li><li><p>对所有类型的文件都进行压缩并清理注释，包括了：js、wxml、wxss、json；</p></li></ol><p>此外，京喜首页团队还针对 Taro 开发场景进行了如下优化：</p><ol start="5"><li>分析出编译后每个文件的高频重复代码（如处理兼容性的 pollyfill 代码），拆分生成公共文件，替换原引用以实现共用。</li></ol><h2 id="标准和工具" class="post-heading"><a href="#标准和工具" class="headerlink" title="标准和工具"></a>标准和工具<a class="post-anchor" href="#标准和工具" aria-hidden="true"></a></h2><p>在开始正式介绍瘦身实践之前，我们先来明确一下代码包体积的衡量标准和统计方式吧。</p><p>小程序上传代码以代码包尺寸为准，所谓 2M 的限制，就是指该尺寸不能超过 2048KB。</p><p>从信息传输角度来说，Gzip 等压缩工具可以进行很多信息化编码优化，因此一些内容重复是可以容忍的，但是由于我们的目标是为了解决小程序上传限制，就只有对代码包尺寸锱铢必较了。</p><p>在开发者工具-详情-基本信息-上次预览或上次上传，可以查看到最近一次的代码包体积，本文接下来所介绍的优化都是以缩小这个体积为目的。</p><p><img src="https://img20.360buyimg.com/ling/jfs/t1/141980/32/15643/20505/5fbcd1b9E5ccc5e93/3e5b1e0b74f1beed.png" alt="查看代码包尺寸"></p><p>但是代码上传生成模板速度很慢，如果每次都要根据这里的数据来统计体积变化，效率太低了。</p><p>在未改动项目配置的情况下，我们就可以间接以代码目录的文件体积大小作为变化参照。怎么方便的统计文件体积呢？这里我用了<a href="https://github.com/MrRaindrop/tree-cli" target="_blank" rel="noopener">tree-cli</a>，利用它提供的参数，可以输出具备尺寸统计和排序功能的代码文件清单：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install -g <span class="built_in">tree</span>-cli</span><br><span class="line">// 目标目录</span><br><span class="line"><span class="built_in">cd</span> target-directory</span><br><span class="line">// 输出文件为 size-analysis.<span class="built_in">md</span></span><br><span class="line"><span class="built_in">tree</span> -s --sort=size -o size-analysis.<span class="built_in">md</span></span><br></pre></td></tr></table></figure><p>清单内容格式如下：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── <span class="selector-attr">[      1000]</span>  <span class="selector-tag">index</span><span class="selector-class">.js</span></span><br><span class="line">├── <span class="selector-attr">[       500]</span>  <span class="selector-tag">index</span><span class="selector-class">.wxss</span></span><br><span class="line">├── <span class="selector-attr">[       500]</span>  <span class="selector-tag">index</span><span class="selector-class">.wxml</span></span><br><span class="line">├── <span class="selector-attr">[       500]</span>  <span class="selector-tag">index</span><span class="selector-class">.json</span></span><br><span class="line">├── <span class="selector-attr">[      4000]</span>  <span class="selector-tag">components</span></span><br><span class="line">│   ├── <span class="selector-attr">[      4000]</span>  <span class="selector-tag">child</span></span><br><span class="line">│   │   ├── <span class="selector-attr">[      1000]</span>  <span class="selector-tag">index</span><span class="selector-class">.js</span></span><br><span class="line">│   │   ├── <span class="selector-attr">[      1000]</span>  <span class="selector-tag">index</span><span class="selector-class">.wxml</span></span><br><span class="line">│   │   ├── <span class="selector-attr">[      1000]</span>  <span class="selector-tag">index</span><span class="selector-class">.wxss</span></span><br><span class="line">└── └── └── <span class="selector-attr">[      1000]</span>  <span class="selector-tag">index</span><span class="selector-class">.json</span></span><br><span class="line">  </span><br><span class="line">6500 <span class="selector-tag">bytes</span> <span class="selector-tag">used</span> <span class="selector-tag">in</span> 2 <span class="selector-tag">directories</span>, 8 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure><h2 id="瘦身实践" class="post-heading"><a href="#瘦身实践" class="headerlink" title="瘦身实践"></a>瘦身实践<a class="post-anchor" href="#瘦身实践" aria-hidden="true"></a></h2><p>前面说到京喜首页优化措施都做的很好了，下面即将分享的是一些不那么常见的优化方式，优化空间有大有小，想要优化小程序代码包，建议先尽量完成前文提到的优化方案，这样获得的收益最明显，然后再来看接下来提到的这些方式吧~</p><h3 id="一、字体和颜色的全局共用" class="post-heading"><a href="#一、字体和颜色的全局共用" class="headerlink" title="一、字体和颜色的全局共用"></a>一、字体和颜色的全局共用<a class="post-anchor" href="#一、字体和颜色的全局共用" aria-hidden="true"></a></h3><p>小程序文档内关于继承样式的说明为：继承样式，如<code>font</code>,<code>color</code>, 会从组件外继承到组件内。</p><p>分析项目现状，我们通常会把字体定义放在公共 css 文件内，随着页面或组件引入公共 css，font 也将被重复引入，可以通过改造，把 font 的定义仅放在 app.wxss 内，取消组件和页面的引入，可以达到减少整体代码包体积的目的。</p><p>关于这一项首页项目体积减少1%，预估整个项目还有 20kb 左右的 font 定义可清理。</p><p>如果有全局的颜色定义，也可以进行类似的优化。</p><h3 id="二、样式补全功能的使用" class="post-heading"><a href="#二、样式补全功能的使用" class="headerlink" title="二、样式补全功能的使用"></a>二、样式补全功能的使用<a class="post-anchor" href="#二、样式补全功能的使用" aria-hidden="true"></a></h3><p>作为 web 开发者，对 -webkit- 这种前缀一定不陌生，为了适配不同浏览器内核，通常我们会在编译阶段使用 autoprefixer 进行样式的自动补全。</p><p>而小程序开发者工具也提供了样式补全的能力：详情-本地设置-可以勾选「上传代码时样式自动补全」</p><p>这个补全和我们在编译时做的有什么不同吗？</p><p>关键在于它实现的时机：如果是本地模板上传前，那么应该和我们编译的补全效果一样；如果是在上传模板后，也许可以借此减掉补全内容所占的尺寸。</p><p>结合小程序代码包传递过程和样式补全时机，大概有以下3种情况：</p><p>阶段一补全：</p><p><img src="https://img10.360buyimg.com/ling/jfs/t1/143666/20/16342/51366/5fc4aad2Ef0d502ce/bd7e1c8800de02e9.png" alt="image-20201119103740502"></p><p>阶段二：</p><p><img src="https://img14.360buyimg.com/ling/jfs/t1/134362/18/17942/49773/5fc4aad6E13eb2362/37e0aa0a62bfcff5.png" alt="image-20201119103807546"></p><p>或者是阶段三：</p><p><img src="https://img13.360buyimg.com/ling/jfs/t1/129844/15/17945/49388/5fc4aadcEfccb1a95/27a4bf846553cac3.png" alt="image-20201119103830070"></p><p>为了验证猜想，来做一个实验吧，比较「 项目编译不补全样式+开发者工具设置样式补全」 vs「 项目编译补全样式+开发者工具不设置样式补全」，模板体积统计如下：</p><p><img src="https://img12.360buyimg.com/ling/jfs/t1/132774/6/17951/70297/5fc4ac4dEe9d95143/28fdb0be2cfeb56d.png" alt="开发者工具提供样式补全"></p><p><img src="https://img10.360buyimg.com/ling/jfs/t1/152190/14/7881/88282/5fc4ac33Ed0992ccd/ec17cab8c68050cb.png" alt="编译提供样式补全"></p><p>可见前者比后者少了 58kb，这说明，开发者工具提供的样式补全不是在阶段一做的，不然模板体积应该和我们自己做的编译补全基本一致。</p><p>那么，就可以愉快的去掉编译补全，使用小程序开发者工具提供的能力了。</p><p>不过这样改动会出现一个小问题，开发者工具内的样式是未经补全处理的，个别样式会有点问题，测试就发现 mask-border-source 无效，而相应真机因为已添加样式补全没有问题。为了不出现预览误会，建议给这种尚未支持的样式手动写上 -webkit- 前缀，保证开发和真机表现一致。</p><h3 id="三、小心-Sass" class="post-heading"><a href="#三、小心-Sass" class="headerlink" title="三、小心 Sass!"></a>三、小心 Sass!<a class="post-anchor" href="#三、小心-Sass" aria-hidden="true"></a></h3><p>sass/less 等工具使得 css 的编写变得更加流畅，函数和变量的引入也让 css 有了一点工程化的意味。但是你有没有观察过 sass 的编译实现呢？</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.scss，作为被引用方</span></span><br><span class="line">.banner &#123;         <span class="comment">// 样式定义</span></span><br><span class="line">	<span class="built_in">color</span>: <span class="built_in">red</span>;</span><br><span class="line">&#125;</span><br><span class="line">$COLOR = <span class="built_in">red</span>     <span class="comment">//  变量定义（函数定义类似）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// b.scss，作为使用方</span></span><br><span class="line">@<span class="keyword">import</span> <span class="string">'a.scss'</span>;</span><br><span class="line">.banner_wrapper &#123;</span><br><span class="line">	<span class="built_in">background</span>: white;</span><br><span class="line">	<span class="built_in">color</span>:$COLOR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关注b.sass的编译后：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.scss的引用消失了，内容被整合到文件内</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.banner</span> &#123;              <span class="comment">// a.scss内的样式定义会被拷贝进来</span></span><br><span class="line">	<span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.banner_wrapper</span> &#123;</span><br><span class="line">	<span class="attribute">background</span>: white;</span><br><span class="line">	<span class="attribute">color</span>:red;           <span class="comment">//变量定义会被按值替换</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里出现的问题是：我们是否需要<code>.banner</code>被拷贝进来呢</p><p>为了避免多引入不需要的样式定义，有以下几个方向：</p><ol><li><p>按功能拆分 a.scss 内的样式定义，按需引入。</p></li><li><p>使用 @include 语法，将 banner 的定义变成一个变量，按需引入。</p></li></ol><p>而在小程序场景，wxss 语法支持 @import，实现了极弱版的模块化，使得我们可以再加一个角度解决上面的问题：</p><ol start="3"><li>绕过 sass 编译，使用小程序的 @import 语法，引入需要的样式定义。（关于如何绕开 sass 编译，可以考虑使用注释片段，或者白名单筛选识别）</li></ol><h3 id="四、多端场景的冗余代码移除" class="post-heading"><a href="#四、多端场景的冗余代码移除" class="headerlink" title="四、多端场景的冗余代码移除"></a>四、多端场景的冗余代码移除<a class="post-anchor" href="#四、多端场景的冗余代码移除" aria-hidden="true"></a></h3><p>京喜首页项目使用 Taro 开发，需要适配 H5/微信小程序/QQ小程序等多端场景，利用 Taro 提供的环境变量能力，可以在方法内部实现多端差异处理，比如下面这段：</p><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">init()&#123;</span><br><span class="line">  <span class="keyword">if</span>(process.env.<span class="type">TARO_ENV</span> === 'weapp'&#123;</span><br><span class="line">     // 微信小程序逻辑</span><br><span class="line">     this.initWeapp()</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(process.env.<span class="type">TARO_ENV</span> === 'h5')&#123;</span><br><span class="line">     // <span class="type">H5</span>页面逻辑</span><br><span class="line">     this.initH5()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">initWeapp()<span class="meta">&#123;...&#125;</span></span><br><span class="line">initH5()<span class="meta">&#123;...&#125;</span></span><br></pre></td></tr></table></figure><p>小程序端打包后代码：</p><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">init()&#123;</span><br><span class="line">	this.initWeapp()</span><br><span class="line">&#125;</span><br><span class="line">initWeapp()<span class="meta">&#123;...&#125;</span></span><br><span class="line">initH5()<span class="meta">&#123;...&#125;</span></span><br></pre></td></tr></table></figure><p>但是，环境变量方式没办法处理 initH5 这种方法定义，导致也被打包进来了。</p><p>因此，我们需要更强大的差异打包：京喜首页利用内部的 wxa-cli 工具提供的条件编译能力，通过注释段落标记，圈注出多端内容，实现了代码片段层面的差异打包，细节如下：</p><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">init()&#123;</span><br><span class="line">  <span class="keyword">if</span>(process.env.<span class="type">TARO_ENV</span> === 'weapp'&#123;</span><br><span class="line">     // 微信小程序逻辑</span><br><span class="line">     this.initWeapp()</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(process.env.<span class="type">TARO_ENV</span> === 'h5')&#123;</span><br><span class="line">     // <span class="type">H5</span>页面逻辑</span><br><span class="line">     this.initH5()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">initWeapp()<span class="meta">&#123;...&#125;</span></span><br><span class="line">/* wxa <span class="keyword">if</span>:<span class="keyword">type</span>=='h5' */  标记h5端代码开始位置</span><br><span class="line">initH5()<span class="meta">&#123;...&#125;</span></span><br><span class="line">/* /wxa  */              标记注释结束位置</span><br></pre></td></tr></table></figure><p>打包后代码：</p><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">init()&#123;          // weapp内</span><br><span class="line">	this.initWeapp()</span><br><span class="line">&#125;</span><br><span class="line">initWeapp()<span class="meta">&#123;...&#125;</span></span><br></pre></td></tr></table></figure><p>initH5 消失了，代码更瘦了</p><h3 id="五、整理-log" class="post-heading"><a href="#五、整理-log" class="headerlink" title="五、整理 log"></a>五、整理 log<a class="post-anchor" href="#五、整理-log" aria-hidden="true"></a></h3><p>为了调试方便，你的项目内有没有打很长的 log，类似于这种：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.<span class="built_in">log</span>('==============xx接口异常============')</span><br></pre></td></tr></table></figure><p>经过测试，首页代码文件内有 5KB 的内容是 log 语句，可以试着优化一下：</p><ol><li><p>及时移除开发调试用 log</p></li><li><p>信息类 log 约定长度更短的格式</p></li></ol><h3 id="六、良好的编码策略" class="post-heading"><a href="#六、良好的编码策略" class="headerlink" title="六、良好的编码策略"></a>六、良好的编码策略<a class="post-anchor" href="#六、良好的编码策略" aria-hidden="true"></a></h3><p>有没有同样的逻辑需求，可以用更短更优雅的写法来实现呢？</p><p>关于代码分析是个很复杂的话题，暂时列一个结论相对明确的写法吧</p><h4 id="格式化数据时数据的存取和中间变量问题" class="post-heading"><a href="#格式化数据时数据的存取和中间变量问题" class="headerlink" title="格式化数据时数据的存取和中间变量问题"></a>格式化数据时数据的存取和中间变量问题<a class="post-anchor" href="#格式化数据时数据的存取和中间变量问题" aria-hidden="true"></a></h4><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function format(list)&#123;</span><br><span class="line"> let result = []</span><br><span class="line"> list.forEach(item =&gt; &#123;</span><br><span class="line">    const &#123;</span><br><span class="line"><span class="built_in">      a,</span></span><br><span class="line"><span class="built_in">      b,</span></span><br><span class="line"><span class="title">      c:</span> f,</span><br><span class="line"><span class="built_in">      d,</span></span><br><span class="line"><span class="built_in">      e,</span></span><br><span class="line">    &#125; = item</span><br><span class="line"></span><br><span class="line">    result.push(&#123;</span><br><span class="line"><span class="built_in">      a,</span></span><br><span class="line"><span class="built_in">      b,</span></span><br><span class="line"><span class="built_in">      f,</span></span><br><span class="line"><span class="built_in">      d,</span></span><br><span class="line"><span class="built_in">      e,</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>可以利用 lodash 的 pick 方法改写成：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; pick &#125; <span class="keyword">from</span> <span class="string">'lodash/pick'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params">list</span>)</span>&#123;</span><br><span class="line"> <span class="keyword">return</span> list.map(<span class="function"><span class="params">item</span>=&gt;</span>(&#123;</span><br><span class="line"> 	...pick(item,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>),</span><br><span class="line"> 	f:item.c</span><br><span class="line"> &#125;))</span><br></pre></td></tr></table></figure><h3 id="七、样式命名编译优化" class="post-heading"><a href="#七、样式命名编译优化" class="headerlink" title="七、样式命名编译优化"></a>七、样式命名编译优化<a class="post-anchor" href="#七、样式命名编译优化" aria-hidden="true"></a></h3><p>京喜首页项目由于 H5 端混搭老项目，为了避免类名冲突，采用了形如<code>block-name__element--modifier</code>的 bem 命名规则。在开发中进一步发现，一些类似 <code>navbar-content__item</code> 的常见命名偶尔撞车，为了避免冲突，类名就越写越长，而小程序代码包的尺寸影响也在悄悄增大。</p><p>为了解决命名冲突的问题，将类名 hash 化是个好办法，css-modules 就是个成熟的插件，可以通过配置规则，对样式名编译出「文件名+内容相关」的独特化 hash。</p><p>但是研究下它的实现，会发现对代码尺寸的影响不容乐观，看一个编译后例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">'./index.module.map.scss.js'</span> <span class="comment">//js文件，增加一句jsMap的引入</span></span><br><span class="line"></span><br><span class="line">&lt;view className=&#123;style.banner&#125;&gt;<span class="xml"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span>  <span class="comment">// wxml文件，每处类名都比原类名增加了`style.`的引用 </span></span><br><span class="line"></span><br><span class="line">.hash &#123; xx &#125;   <span class="comment">// wxss文件， 类名被hash化，减少的具体尺寸为:原类名-hash </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; <span class="attr">banner</span> : hash &#125;  <span class="comment">// 新增了一个map文件，实现原名与hash名的映射，增加的具体尺寸为:原类名+hash</span></span><br></pre></td></tr></table></figure><p>计算整体内容变化：</p><ol><li><p>js 内新增引入 map 语句：增加一句代码</p></li><li><p>wxml 内：原为 n 个类名，现为 n 个「style.+原类名」，增量为 n 个<code>style.</code></p></li><li><p>map 文件 与 wxss 文件合计：map 内有 n 个原类名与 hash 映射， wxss 现为 n 个 hash ， 减去原来的 n 个原类名 ，合计增量为 2n 个 hash</p></li></ol><p>可见引入 css-modules 会导致整体代码尺寸增加。</p><p>会不会觉得这个新增的 map 文件的作用特别熟悉呢？</p><p>在我们压缩 js 文件时，会有一个 sourceMap 文件，它保留了原始命名和代码位置，可以方便定位和 debug。</p><p>css-modules 实现的 map 文件，在我看来作用和 sourceMap 的命名索引差不多，对于代码逻辑来说，除了保持原类名的引用信息，它好像也没什么用了，在尺寸敏感场景，就可以考虑去掉 map 文件，还是上文的示例，如果可以实现成这样就好了：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">//</span> import style from '<span class="string">./index.module.map.scss.js</span>'   js文件取消map的引入</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> wxml文件</span><br><span class="line">&lt;view className=<span class="string">"hash"</span>&gt;&lt;<span class="string">/view</span>&gt;   <span class="string">//</span> 对style.banner进行求值并替换  </span><br><span class="line"></span><br><span class="line"><span class="string">//</span> wxss文件</span><br><span class="line"><span class="string">.hash</span> &#123; xx &#125;    <span class="string">//</span> 这里不变</span><br><span class="line"></span><br><span class="line">module.exports = &#123; banner : hash &#125;   <span class="string">//</span> 删掉不要</span><br></pre></td></tr></table></figure><p>网上遍寻没有相关的处理，只能自己造轮子开搞了。</p><p>由于当前主要目的是对小程序代码瘦身，H5 端文件处理和小程序也有一些差异，所以暂时只对小程序场景造了插件，取名 <strong>weapp-css-modules</strong> ，github 地址在这里：<a href="https://github.com/o2team/weapp-css-modules" target="_blank" rel="noopener">https://github.com/o2team/weapp-css-modules</a></p><p>大概思路是：</p><ol><li><p>完成小程序的 css-modules 实现</p></li><li><p>在此基础上进行 map 移除的相关简化逻辑</p></li><li><p>进一步的，考虑到小程序组件内默认样式隔离的特性，对 hash 化的命名再次缩短，变成单字母编排。</p></li></ol><p>如果是只开发小程序端，可以借此实现小程序样式命名相关的代码瘦身，而对于 Taro 开发的多端场景，还可以同时解决 h5 端的命名冲突问题。</p><p>还是上面的例子，下面是 <strong>weapp-css-modules</strong> 编译后效果：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js文件</span></span><br><span class="line"><span class="keyword">let</span> style = &#123;&#125;    <span class="comment">// 不引用map，加入对不规范引入style的兼容</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// wxml文件</span></span><br><span class="line">&lt;view className=<span class="string">"a"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span>   <span class="comment">// 对style.banner进行求值并替换，加入单字母编排</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// wxss文件</span></span><br><span class="line">.a &#123; xx &#125;     <span class="comment">// 因为小程序组件样式隔离，所以可以最短化类名</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; <span class="attr">banner</span> : hash &#125;        <span class="comment">// 删掉不要</span></span><br></pre></td></tr></table></figure><p>京喜首页项目通过改造组件采用 css-modules 写法，加上 <strong>weapp-css-modules</strong> 编译，代码相对尺寸减少了 10%，还是很有效果的，感兴趣的同学可以试用一下。</p><h3 id="总结" class="post-heading"><a href="#总结" class="headerlink" title="总结"></a>总结<a class="post-anchor" href="#总结" aria-hidden="true"></a></h3><p>关于代码瘦身，想提一下信息学中熵的概念：熵反映信息的无序程度，一段信息无序程度越低，它的熵值越低，可被压缩的空间越大；无序程度越高，熵值越高，可被压缩的空间越小。而数据压缩或者是代码瘦身的过程，就是通过优化信息存储方式以逼近它真实的熵值。</p><p>从这个角度来说：</p><ul><li><p>「字体和颜色的全局共用」和「样式补全功能的使用」是借用小程序提供的能力，信息量没变；</p></li><li><p>「小心 Sass」、「多端场景的冗余代码移除」是减少不用的信息；</p></li><li><p>「整理 log」和「样式命名编译优化」是凝练有效信息；</p></li></ul><p>看起来最不好归类的是「良好的编码策略」，它是在编码阶段对信息的梳理和整合，也算凝练有效信息吧。</p><p>以上就是京喜首页项目这次代码瘦身的主要方式了，除此之外的删除不用文件、整合公共文件这些体力活，我就不再啰嗦了。通过以上方式，京喜首页代码在原本优化良好的基础上，实现了再次减重30%的目标，希望能给小程序开发者们带来有价值的信息和思考。</p><p>参考资料</p><p>[1] CSS Modules: <a href="https://github.com/css-modules/css-modules" target="_blank" rel="noopener">https://github.com/css-modules/css-modules</a></p><p>[2] Tree-Cli: <a href="https://github.com/MrRaindrop/tree-cli" target="_blank" rel="noopener">https://github.com/MrRaindrop/tree-cli</a></p><p>[3] 小程序工程化探索: <a href="https://mp.weixin.qq.com/s/_NSJTQ-4-8gTnwTVK-tn0A" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/_NSJTQ-4-8gTnwTVK-tn0A</a></p><p>[4] 微信小程序 限制2M的瘦身技巧与方法详解: <a href="https://blog.csdn.net/wlanye/article/details/73457700" target="_blank" rel="noopener">https://blog.csdn.net/wlanye/article/details/73457700</a></p><div class="post-tags" style="display:none"><a href="/tags/性能优化/">性能优化</a> <a href="/tags/小程序/">小程序</a></div><div class="post-categories" style="display:none"><a href="/cates/小程序/">小程序</a></div><div class="post-announce">感谢您的阅读，本文由 <a href="//aotu.io">凹凸实验室</a> 版权所有。如若转载，请注明出处：凹凸实验室（<a href="https://aotu.io/notes/2020/11/30/jx-code-slim/">https://aotu.io/notes/2020/11/30/jx-code-slim/</a>）</div><div class="post-revision"><i class="fa fa-clock-o"></i> <time class="post-updated" datetime="2021-02-02T07:48:05.254Z">上次更新：2021-02-02 15:48:05</time></div></div><div class="post-nav"><div class="post-nav-next"><a href="/notes/2020/12/24/aotu-5-year/" title="凹凸实验室的过去与未来">凹凸实验室的过去与未来 <i class="fa fa-chevron-right"></i></a></div><div class="post-nav-prev"><a href="/notes/2020/11/23/vue-ref-sugar-javascript-label/" title="因为 Vue Ref 提案，我又刷了遍 label 语法"><i class="fa fa-chevron-left"></i> 因为 Vue Ref 提案，我又刷了遍 label 语法</a></div></div><div class="post-comments" id="comments"></div><script>var gitalkOpts={id:"bm90ZXMvMjAyMC8xMS8zMC9qeC1jb2RlLXNsaW0v",owner:"o2team",repo:"o2team.github.io",title:"京喜小程序首页瘦身实践",body:"https://aotu.io/notes/2020/11/30/jx-code-slim/index.html\n\n给小程序再减重30%的秘密",clientID:"3c4d153e6874260f9c7e",clientSecret:"dd44012504c6168bc05b9266e0554bb28c62ce15",admin:["Silencesnow"]}</script></article></div><aside class="mod-side" id="sidebar"><div class="mod-side-sec aotuwx"><img class="aotuwx-qrcode" src="/img/qrcode.jpg" alt="关注我们"><div class="aotuwx-slogan">每周推送精选技术文章</div></div><div class="mod-side-sec works"><div class="mod-side-sec-hd"><h2>服务/产品</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="//taro.jd.com" target="_blank" title="Taro">Taro</a></li><li><a href="//taro-ui.jd.com" target="_blank" title="Taro-UI">Taro-UI</a></li><li><a href="//taro-ext.jd.com" target="_blank" title="Taro 物料市场">Taro 物料市场</a></li><li><a href="//taro-club.jd.com" target="_blank" title="Taro 官方论坛">Taro 官方论坛</a></li><li><a href="//cases.aotu.io/mobi/maga.html" target="_blank" title="拇指期刊">拇指期刊</a></li><li><a href="//athena.aotu.io/" target="_blank" title="Athena">Athena</a></li><li><a href="//guide.aotu.io/" target="_blank" title="前端代码规范">前端代码规范</a></li><li><a href="//halojs.aotu.io/" target="_blank" title="HaloJS">HaloJS</a></li><li><a href="//sign.aotu.io/" target="_blank" title="邮件签名工具">邮件签名工具</a></li><li><a href="//mac.aotu.io/" target="_blank" title="MAC全栈环境">MAC全栈环境</a></li><li><a href="//xcel.aotu.io" target="_blank" title="Excel Filter">Excel Filter</a></li><li><a href="//aotu.jd.com/share/" target="_blank" title="凹凸公开课">凹凸公开课</a></li><li><a href="//at.aotu.io" target="_blank" title="AT-UI">AT-UI</a></li></ul></div></div><div class="mod-side-sec favlinks"><div class="mod-side-sec-hd"><h2>友情链接</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="https://www.cloudbase.net" target="_blank" title="小程序·云开发"><img style="width:22px;vertical-align:middle" src="https://img20.360buyimg.com/ling/jfs/t1/57175/5/15617/50216/5dca6729E00cdff5d/631622525425290e.png">小程序·云开发</a></li><li><a href="https://ling.jd.com" target="_blank" title="京东羚珑智能设计">羚珑智能设计</a></li><li><a href="https://jdrd.jd.com" target="_blank" title="京东零售设计服务平台">京东零售设计服务平台</a></li><li><a href="https://jdc.jd.com" target="_blank" title="京东设计中心">JDC京东设计中心</a></li><li><a href="http://dopro.io/" target="_blank" title="腾讯 Deep Ocean">Deep Ocean</a></li><li><a href="http://fex.baidu.com" target="_blank" title="百度Web前端研发部">百度FEX</a></li><li><a href="http://taobaofed.org" target="_blank" title="淘宝前端团队">淘宝FED</a></li><li><a href="http://tgideas.qq.com" target="_blank" title="腾讯互娱设计中心">TGIdeas</a></li><li><a href="http://isux.tencent.com" target="_blank" title="腾讯SNG设计中心">ISUX</a></li><li><a href="http://cdc.tencent.com" target="_blank" title="腾讯用户研究与体验设计中心">CDC</a></li><li><a href="http://ued.ctrip.com" target="_blank" title="携程设计委员会">携程UED</a></li><li><a href="https://uiiiuiii.com/" target="_blank" title="优优教程网">优优教程网</a></li><li><a href="https://www.designup.cn/" target="_blank" title="Designup">Designup</a></li><li><a href="http://eux.baidu.com/" target="_blank" title="百度EUX">百度EUX</a></li></ul></div></div></aside></div></div><div class="mod-backtop" id="backTop"><i class="fa fa-long-arrow-up"></i></div><footer class="mod-ft" id="footer"><div class="grid"><ul class="mod-ft-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="https://github.com/o2team/o2team.github.io" target="_blank"><i class="fa fa-github-alt"></i></a></li></ul><div class="mod-ft-sec mod-ft-copyright"><p>Designed by <a href="http://aotu.io" target="_blank">凹凸实验室</a> @<a target="_blank" href="http://jdc.jd.com">京东用户体验设计部</a></p><p>Copyright &copy; 2021. All Rights Reserved.</p><p><a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备15077732号-2</a></p></div></div></footer><script src="/js/bundle/core.js"></script><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/post_wx_share.js"></script><script src="/js/bundle/gitalk.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e850b980d029480b092fdd7503c3f8de";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript" src="https://tajs.qq.com/stats?sId=53685723" charset="UTF-8"></script></body></html>