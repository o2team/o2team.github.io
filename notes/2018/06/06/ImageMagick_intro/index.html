<!DOCTYPE html><html class="theme-lattice"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>图像处理 - ImageMagick 简单介绍与案例 | Aotu.io「凹凸实验室」</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="凹凸实验室"><meta name="designer" content="凹凸实验室"><meta name="rating" content="general"><meta name="format-detection" content="telephone=yes"><meta name="robots" content="index, follow"><meta baidu-gxt-verify-token="2b74a5aea155a215abea8547f929190c"><meta name="keywords" content="node.js,linux,ImageMagick,图像处理,凹凸实验室,Aotu,前端开发,全栈开发,IOS开发,Android开发"><link rel="canonical" href="https://aotu.io/notes/2018/06/06/ImageMagick_intro/index.html"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon-48x48.png"><link rel="manifest" href="/img/manifest.json"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#2f83cd"><meta name="application-name" content="Aotu.io"><link rel="apple-touch-icon" sizes="57x57" href="/img/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/img/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/img/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/img/apple-touch-icon-1024x1024.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Aotu.io"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/img/mstile-144x144.png"><meta name="msapplication-config" content="/img/browserconfig.xml"><meta property="wb:webmaster" content="a1686eb81db284d5"><meta name="wechat-logo" content="https://img11.360buyimg.com/ling/jfs/t20107/216/1156926714/50127/ef5c96dc/5b1666efN68d69000.jpg"><meta name="wechat-title" content="图像处理 - ImageMagick 简单介绍与案例"><meta name="wechat-desc" content="ImageMagick 是一款创建、编辑、合成，转换图像的命令行工具。支持格式超过 200 种，包括常见的 PNG, JPEG, GIF, HEIC, TIFF, DPX, EXR, WebP, Postscript, PDF, SVG 等。功能包括调整，翻转，镜像(mirror)，旋转，扭曲，修剪和变换图像，调整图像颜色，应用各种特殊效果，或绘制文本，线条，多边形，椭圆和贝塞尔曲线等。本文主要介绍一下 ImageMagick 的用法与细节。"><link rel="dns-prefetch" href="//storage.360buyimg.com"><link rel="dns-prefetch" href="//img10.360buyimg.com"><link rel="dns-prefetch" href="//img11.360buyimg.com"><link rel="dns-prefetch" href="//img12.360buyimg.com"><link rel="dns-prefetch" href="//img13.360buyimg.com"><link rel="dns-prefetch" href="//img14.360buyimg.com"><link rel="dns-prefetch" href="//img20.360buyimg.com"><link rel="dns-prefetch" href="//img30.360buyimg.com"><link rel="dns-prefetch" href="//misc.aotu.io"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" href="/atom.xml" title="Aotu.io"><meta name="description" content="在客户端我们可以用 PhotoShop 等 GUI 工具处理静态图片或者动态 GIF 图片，不过在服务器端对于 WEB 应用程序要处理图片格式转换，缩放裁剪，翻转扭曲，PDF解析等操作， GUI 软件就很难下手了，所以此处需要召唤命令行工具来帮我们完成这些事。 ImageMagick: 是一款创建、编辑、合成，转换图像的命令行工具。支持格式超过 200 种，包括常见的 PNG, JPEG, GI"><meta name="keywords" content="图像处理,ImageMagick,linux,node.js"><meta property="og:type" content="article"><meta property="og:title" content="图像处理 - ImageMagick 简单介绍与案例"><meta property="og:url" content="https://aotu.io/notes/2018/06/06/ImageMagick_intro/index.html"><meta property="og:site_name" content="Aotu.io"><meta property="og:description" content="在客户端我们可以用 PhotoShop 等 GUI 工具处理静态图片或者动态 GIF 图片，不过在服务器端对于 WEB 应用程序要处理图片格式转换，缩放裁剪，翻转扭曲，PDF解析等操作， GUI 软件就很难下手了，所以此处需要召唤命令行工具来帮我们完成这些事。 ImageMagick: 是一款创建、编辑、合成，转换图像的命令行工具。支持格式超过 200 种，包括常见的 PNG, JPEG, GI"><meta property="og:locale" content="zh-cn"><meta property="og:image" content="https://img13.360buyimg.com/ling/jfs/t20092/208/1167159371/53422/6b06756f/5b161da3Nec0d6b0d.png"><meta property="og:image" content="https://img20.360buyimg.com/ling/jfs/t21091/171/680652696/44636/6ceaa42c/5b161da0Nf2158787.jpg"><meta property="og:image" content="https://img10.360buyimg.com/ling/jfs/t20143/186/680399623/7216/bd166545/5b161aefN83150dd6.jpg"><meta property="og:image" content="https://img13.360buyimg.com/ling/jfs/t20998/239/710863618/17515/6d03d48b/5b161aedN50ba4b89.jpg"><meta property="og:image" content="https://sfault-image.b0.upaiyun.com/217/323/2173239304-5b13729a9441a_articlex"><meta property="og:image" content="https://img11.360buyimg.com/ling/jfs/t21829/207/694662510/406338/15330984/5b161affN1867e1c9.jpg"><meta property="og:image" content="https://img11.360buyimg.com/ling/jfs/t21955/234/742104977/71488/5b55a29f/5b1665d4Nfe4bd0aa.png"><meta property="og:updated_time" content="2021-02-02T07:48:05.246Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="图像处理 - ImageMagick 简单介绍与案例"><meta name="twitter:description" content="在客户端我们可以用 PhotoShop 等 GUI 工具处理静态图片或者动态 GIF 图片，不过在服务器端对于 WEB 应用程序要处理图片格式转换，缩放裁剪，翻转扭曲，PDF解析等操作， GUI 软件就很难下手了，所以此处需要召唤命令行工具来帮我们完成这些事。 ImageMagick: 是一款创建、编辑、合成，转换图像的命令行工具。支持格式超过 200 种，包括常见的 PNG, JPEG, GI"><meta name="twitter:image" content="https://img13.360buyimg.com/ling/jfs/t20092/208/1167159371/53422/6b06756f/5b161da3Nec0d6b0d.png"><meta name="twitter:site" content="o2circle"><script>var App={root:"/",isHome:!1,isCate:!1,isTag:!1}</script><script>window.WechatShareData={imgUrl:"https://img11.360buyimg.com/ling/jfs/t20107/216/1156926714/50127/ef5c96dc/5b1666efN68d69000.jpg",link:window.location.href,title:"图像处理 - ImageMagick 简单介绍与案例",desc:"ImageMagick 是一款创建、编辑、合成，转换图像的命令行工具。支持格式超过 200 种，包括常见的 PNG, JPEG, GIF, HEIC, TIFF, DPX, EXR, WebP, Postscript, PDF, SVG 等。功能包括调整，翻转，镜像(mirror)，旋转，扭曲，修剪和变换图像，调整图像颜色，应用各种特殊效果，或绘制文本，线条，多边形，椭圆和贝塞尔曲线等。本文主要介绍一下 ImageMagick 的用法与细节。"},window.WechatJSSDKURL="https://aotu.jd.com/aotu-wx-api/api/wx/jssdk/signature"</script></head><body class="page-post-detail"><div class="mod-hd"><div class="grid"><div class="mod-logo"><a href="/index.html" title="Aotu.io">Aotu.io</a></div><span class="mod-hd-toggle" id="J_hdToggle"><i class="fa fa-bars"></i></span><div class="mod-hd-main"><div class="mod-hd-inner"><nav class="mod-nav"><ul class="mod-nav-list"><li class="main-nav-item"><a href="/index.html" class="main-nav-link">首页</a></li><li class="main-nav-item"><a target="_blank" href="https://geeks.aotu.io" class="main-nav-link">极客沙龙</a></li><li class="main-nav-item"><a href="https://cases.aotu.io" class="main-nav-link">H5案例</a></li><li class="main-nav-item"><a href="/about/" class="main-nav-link">关于</a></li><li class="main-nav-item"><a href="/join/" class="main-nav-link">加入我们</a></li></ul></nav><div class="mod-search" id="J_search"><a class="fa fa-search mod-search-ico" id="J_searchTrigger" title="搜索"></a><form id="J_searchForm" method="get" class="mod-search-form" action="/search/"><input type="text" name="query" class="mod-search-ipt" id="J_searchInput" placeholder="搜索"></form></div></div></div></div></div><div class="mod-container"><div class="grid"><div class="mod-main typo"><article class="post"><div class="post-cover"><img src="https://img11.360buyimg.com/ling/jfs/t21382/242/710567581/125401/630d6b14/5b161ac7N5de78bc7.jpg" alt="图像处理 - ImageMagick 简单介绍与案例"></div><header class="post-hd"><h1 class="post-tit">图像处理 - ImageMagick 简单介绍与案例</h1><div class="post-meta">by <a target="_blank" href="https://github.com/Barrior" class="post-author">Barrior</a> on <span>2018-06-06</span></div><p class="post-subtit" style="display:none"><i class="fa fa-quote-left"></i>ImageMagick 是一款创建、编辑、合成，转换图像的命令行工具。支持格式超过 200 种，包括常见的 PNG, JPEG, GIF, HEIC, TIFF, DPX, EXR, WebP, Postscript, PDF, SVG 等。功能包括调整，翻转，镜像(mirror)，旋转，扭曲，修剪和变换图像，调整图像颜色，应用各种特殊效果，或绘制文本，线条，多边形，椭圆和贝塞尔曲线等。本文主要介绍一下 ImageMagick 的用法与细节。</p><span style="display:none" id="busuanzi_value_page_pv"></span></header><div class="post-content"><a id="more"></a><p>在客户端我们可以用 <code>PhotoShop</code> 等 <code>GUI</code> 工具处理静态图片或者动态 <code>GIF</code> 图片，不过在服务器端对于 <code>WEB</code> 应用程序要处理图片格式转换，缩放裁剪，翻转扭曲，PDF解析等操作， <code>GUI</code> 软件就很难下手了，所以此处需要召唤命令行工具来帮我们完成这些事。</p><p><strong>ImageMagick:</strong> 是一款创建、编辑、合成，转换图像的命令行工具。支持格式超过 <code>200</code> 种，包括常见的 <code>PNG, JPEG, GIF, HEIC, TIFF, DPX, EXR, WebP, Postscript, PDF, SVG</code> 等。功能包括调整，翻转，镜像(mirror)，旋转，扭曲，修剪和变换图像，调整图像颜色，应用各种特殊效果，或绘制文本，线条，多边形，椭圆和贝塞尔曲线等。</p><p>官网：<a href="https://www.imagemagick.org" target="_blank" rel="noopener">https://www.imagemagick.org</a> 下面放个小标识。</p><p><img src="https://img13.360buyimg.com/ling/jfs/t20092/208/1167159371/53422/6b06756f/5b161da3Nec0d6b0d.png" alt="小标识.png"></p><h3 id="安装-ImageMagick" class="post-heading"><a href="#安装-ImageMagick" class="headerlink" title="安装 ImageMagick"></a>安装 ImageMagick<a class="post-anchor" href="#安装-ImageMagick" aria-hidden="true"></a></h3><blockquote><p>支持 <code>Linux, Windows, Mac OS X, iOS, Android OS</code> 等平台<br><a href="https://www.imagemagick.org/script/download.php" target="_blank" rel="noopener">https://www.imagemagick.org/script/download.php</a></p></blockquote><p>因为我是 MAC 机器，演示一下 <code>brew</code> 的安装方式咯<br></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>imagemagick</span><br></pre></td></tr></table></figure><p></p><h3 id="基本命令与格式" class="post-heading"><a href="#基本命令与格式" class="headerlink" title="基本命令与格式"></a>基本命令与格式<a class="post-anchor" href="#基本命令与格式" aria-hidden="true"></a></h3><h4 id="1、基本命令" class="post-heading"><a href="#1、基本命令" class="headerlink" title="1、基本命令"></a>1、基本命令<a class="post-anchor" href="#1、基本命令" aria-hidden="true"></a></h4><blockquote><p><code>ImageMagick</code> 包括一组命令行工具来操作图片，安装好 <code>ImageMagick</code> 后，终端就可以使用如下命令了。</p></blockquote><p><code>magick:</code> 创建、编辑图像，转换图像格式，以及调整图像大小、模糊、裁切、除去杂点、抖动 ( dither )、绘图、翻转、合并、重新采样等。<br><code>convert:</code> 等同于 <code>magick</code> 命令。<br><code>identify:</code> 输出一个或多个图像文件的格式和特征信息，如分辨率、大小、尺寸、色彩空间等。<br><code>mogrify:</code> 与 <code>magick</code> 功能一样，不过不需要指定输出文件，自动覆盖原始图像文件。<br><code>composite:</code> 将一个图片或多个图片组合成新图片。<br><code>montage:</code> 组合多个独立的图像来创建合成图像。每个图像都可以用边框，透明度等特性进行装饰。</p><p><code>compare:</code> 从数学和视觉角度比较源图像与重建图像之间的差异。<br><code>display:</code> 在任何 X server 上显示一个图像或图像序列。<br><code>animate:</code> 在任何 X server 上显示图像序列。<br><code>import:</code> 保存 X server 上的任何可见窗口并把它作为图像文件输出。可以捕捉单个窗口，整个屏幕或屏幕的任意矩形部分。<br><code>conjure:</code> 解释并执行 MSL ( Magick Scripting Language ) 写的脚本。<br><code>stream:</code> 一个轻量级工具，用于将图像或部分图像的一个或多个像素组件流式传输到存储设备。在处理大图像或原始像素组件时很有用。</p><h4 id="2、命令格式" class="post-heading"><a href="#2、命令格式" class="headerlink" title="2、命令格式"></a>2、命令格式<a class="post-anchor" href="#2、命令格式" aria-hidden="true"></a></h4><p>基本命令的使用，遵循 <code>Unix</code> 风格的标准格式：<br></p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">command</span> [<span class="title">options</span>] <span class="title">input_image</span> <span class="title">output_image</span></span><br></pre></td></tr></table></figure><p></p><p>比如我们将一张宽高 <code>300x300</code> 的图片 <code>goods.png</code> 转换成 <code>200x200</code> 的<code>goods.jpg</code>，可以这样用<br></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">convert</span> <span class="selector-tag">-resize</span> 200<span class="selector-tag">x200</span> <span class="selector-tag">goods</span><span class="selector-class">.png</span> <span class="selector-tag">goods</span><span class="selector-class">.jpg</span></span><br></pre></td></tr></table></figure><p></p><blockquote><p><code>-resize</code> 定义图片尺寸，<code>ImageMagick</code> 所有的选项参数都在这个【<a href="https://www.imagemagick.org/script/command-line-options.php" target="_blank" rel="noopener">命令行选项手册</a>】。</p></blockquote><p>但是随着功能的复杂，命令缓慢扩大成了这样的格式：<br></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">command</span> [<span class="keyword">options</span>] image1 [<span class="keyword">options</span>] image2 [<span class="keyword">options</span>] output_image</span><br></pre></td></tr></table></figure><p></p><p>于是上面的命令也可以写成这样<br></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">convert</span> <span class="selector-tag">goods</span><span class="selector-class">.png</span> <span class="selector-tag">-resize</span> 200<span class="selector-tag">x200</span> <span class="selector-tag">goods</span><span class="selector-class">.jpg</span></span><br></pre></td></tr></table></figure><p></p><p><code>笔记：</code>个人建议，如果转换的是一张图片，那么用第一种格式，因为像 <code>-density</code> 等一些选项必须放在 <code>command</code> 与 <code>input_image</code> 之间，所以为了省记都不写错，都写在 <code>command</code> 与 <code>input_image</code> 之间岂不很好。<br>但是如果是多张图片转换，就需要按第二种格式，正确输出命令选项了。</p><p><code>提示：</code>如果上面的工具命令在计算机上不可以使用，则可以把它们当作 <code>magick</code> 命令的子命令使用，例如<br></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">magick</span> <span class="selector-tag">identify</span> <span class="selector-tag">goods</span><span class="selector-class">.png</span></span><br></pre></td></tr></table></figure><p></p><h4 id="3、指定文件格式" class="post-heading"><a href="#3、指定文件格式" class="headerlink" title="3、指定文件格式"></a>3、指定文件格式<a class="post-anchor" href="#3、指定文件格式" aria-hidden="true"></a></h4><p>默认情况下 <code>ImageMagick</code> 会读取图像中唯一标识格式的签名来确定文件格式，如果没有，则根据文件的扩展名来确定格式，如 <code>image.jpg</code> 被认为 <code>jpeg</code> 格式文件，如果都获取不到，则需要手动指定文件的格式。命令格式为 <code>format:input_or_output_image</code>。</p><p>输入文件一般情况应该不需要手动指定文件格式，输出文件的时候，<code>png</code> 格式分 <code>png8</code>、<code>png24</code> 等格式，如果 <code>png8</code> 格式的文件能够满足需求，指定合理的格式可以缩小文件的大小，示例如下。<br></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">convert</span> <span class="selector-tag">goods</span><span class="selector-class">.png</span> <span class="selector-tag">png8</span><span class="selector-pseudo">:goods_8.png</span></span><br><span class="line"><span class="selector-tag">convert</span> <span class="selector-tag">goods</span><span class="selector-class">.png</span> <span class="selector-tag">png24</span><span class="selector-pseudo">:goods_24.png</span></span><br></pre></td></tr></table></figure><p></p><h3 id="实际案例" class="post-heading"><a href="#实际案例" class="headerlink" title="实际案例"></a>实际案例<a class="post-anchor" href="#实际案例" aria-hidden="true"></a></h3><blockquote><p>文中案例基于 <code>ImageMagick 7.0.7</code></p></blockquote><h4 id="1、生成缩略图" class="post-heading"><a href="#1、生成缩略图" class="headerlink" title="1、生成缩略图"></a>1、生成缩略图<a class="post-anchor" href="#1、生成缩略图" aria-hidden="true"></a></h4><p>需求：将一张宽高为 <code>900x600</code> 的图片 <code>goods.jpg</code> 生成宽高为 <code>150x100</code> 的缩略图 <code>thumbnail.jpg</code></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert -resize <span class="number">150</span>x100 -quality <span class="number">70</span> -strip goods.jpg thumbnail.jpg</span><br></pre></td></tr></table></figure><p>解释：</p><ul><li><code>-resize 150x100</code>：定义输出的缩略图尺寸为 <code>150x100</code>。</li><li><code>-quality 70</code>：降低缩略图的质量为 <code>70</code>，取值范围 <code>1</code> ( 最低图像质量和最高压缩率 ) 到 <code>100</code> ( 最高图像质量和最低压缩率 )，默认值根据输出格式有 <code>75</code>、<code>92</code>、<code>100</code>，选项适用于 <code>JPEG / MIFF / PNG</code>。</li><li><code>-strip</code>：让缩略图移除图片内嵌的所有配置文件，注释等信息，以减小文件大小。</li></ul><blockquote><p><code>-resize</code> 延伸解读，如下。</p></blockquote><p>上面的例子中，输入的图片和输出的图片比例是一致的，所以不会有特殊情况出现，但是遇到比例不同的时候，上面的写法并不会得到 <code>150x100</code> 的图像，而是会根据图像的宽高比例，取最大值，得出来的结果可能是 <code>150</code> 宽和更小的高，或者 <code>100</code> 高和更小的宽；所以 <code>IamgeMagick</code> 提供了几种符号来定义缩放。<br></p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">convert</span> -resize <span class="string">'150x100!'</span> goods.jpg thumbnail.jpg</span><br><span class="line"><span class="built_in">convert</span> -resize <span class="string">'150x100&gt;'</span> goods.jpg thumbnail.jpg</span><br><span class="line"><span class="built_in">convert</span> -resize <span class="string">'150x100&lt;'</span> goods.jpg thumbnail.jpg</span><br></pre></td></tr></table></figure><p></p><p><code>!</code>：不管图片宽高如何，都缩放成 <code>150x100</code> 这样的尺寸。<br><code>&gt;</code>：只有宽高均大于 <code>150x100</code> 的图片才缩放成该尺寸 ( 按比例取最大值 )，小于的图片不做处理。<br><code>&lt;</code>：与 <code>&gt;</code> 功能相反。</p><p><code>提示：</code>因为有些字符是 <code>Linux shell</code> 或其他系统的特殊字符，所以需要用引号包裹起来或者用反斜线 <code>\</code> 转义，另外，不同平台可能引号都是有差异的。</p><h4 id="2、添加水印" class="post-heading"><a href="#2、添加水印" class="headerlink" title="2、添加水印"></a>2、添加水印<a class="post-anchor" href="#2、添加水印" aria-hidden="true"></a></h4><p>需求 ① ：给图片居中加上透明文本水印。</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">convert  -draw 'text <span class="number">0</span>,<span class="number">0</span> <span class="string">"JD.COM"</span>'  -fill 'rgba(<span class="number">221</span>, <span class="number">34</span>, <span class="number">17</span>, <span class="number">0.25</span>)'  -pointsize <span class="number">36</span>  \</span><br><span class="line">-font 'cochin.ttc'  -gravity center  joy.jpg  watermark.jpg</span><br></pre></td></tr></table></figure><p>解释：</p><ul><li><code>-draw</code>：绘图选项，<code>text</code> 声明绘制文本， <code>0,0</code> 声明文本距离图片左上角的偏移值， <code>JD.COM</code> 声明绘制的文本，最好用引号包裹起来，避免输入特殊字符引起错误。绘制文本的格式为 <code>text x,y string</code>，当然还可以绘制其他类型，诸如圆 ( circle )、折线 ( polyline )。</li><li><code>-fill</code>：对文本填充颜色，貌似 <code>ImageMagick</code> 命令中<code>前面的选项</code>是用来控制<code>后面的选项</code>的，所以应该把这样的修饰选项放到 <code>-draw</code> 前面比较好，<code>很重要</code>，后面的案例就是这样的。</li><li><code>-pointsize</code>：指定文本的字体大小。</li><li><code>-font</code>：指定字体。</li><li><code>-gravity</code>：设置文本在图片里的排列方式 ( 类似 CSS 里的 align-items + justify-content )，<code>center</code> 表示水平垂直都居中，其他值还可以是：<code>NorthWest, North, NorthEast, West, East, SouthWest, South, SouthEast</code>，不记大小写。</li><li><code>\</code>：反斜线也是类 <code>Unix</code> 系统的续行字符，当一个命令很长时，我们可以把它写成多行，以便视觉上的美观和直观。</li></ul><p>需求 ② ：给图片加上倾斜平铺透明文本水印。</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">convert  -size 100x100  xc:none  \</span><br><span class="line">-<span class="ruby">fill <span class="string">'#d90f02'</span>  -pointsize <span class="number">18</span>  -font <span class="string">'cochin.ttc'</span>  \</span></span><br><span class="line"><span class="ruby">-gravity center  -draw <span class="string">'rotate -45 text 0,0 "JD.COM"'</span>  \</span></span><br><span class="line"><span class="ruby">-resize <span class="number">60</span>%  <span class="symbol">miff:</span>-  <span class="params">|  composite  -tile  -dissolve 25  -  joy.jpg  watermark.jpg</span></span></span><br></pre></td></tr></table></figure><p>解释：文本平铺水印其实是将文本画成一张 <code>png</code> 图片，然后用这张透明图片在目标图片上进行平铺。</p><ul><li><code>-size</code>：设置画布的大小。</li><li><code>xc:</code>：全称 <code>X Constant Image</code>，是 <code>canvas:</code> 的别名，定义一张画布，用来绘图，常用格式为 <code>xc:color</code>，<code>none</code> 或者 <code>transparent</code> 设置画布为透明底，默认为白色。</li><li><code>-resize</code>：该选项还可以指定百分比，意为缩放至原图像的百分之几。貌似 <code>-pointsize</code> 小于 <code>14</code> 后，<code>-draw</code> 里的 <code>rotate</code> 会不生效，所以用 <code>-resize</code> 来把平铺图案变得更小。</li><li><code>miff:-</code>：<ul><li><code>miff:</code> 声明输出 ImageMagick ( IM ) 自己的图像文件格式：<a href="https://www.imagemagick.org/script/miff.php" target="_blank" rel="noopener">MIFF</a>，主要用途是以复杂的方式处理图像时当做中间保存格式，适用于从一个 IM 命令向另一个 IM 命令传递图像元数据和其他关联属性。</li><li><code>-</code> 在管道符前面意为将 IM 命令执行的结果作为标准输出，在管道符后面则表示从标准输入中读取这个数据，如在管道符后面的 <code>composite</code> 中使用 <code>-</code> 读取刚刚生成的透明图像。</li></ul></li><li><code>|</code>：<code>Linux shell</code> 管道符，用于将上一个命令的标准输出传递到下一个命令作为标准输入。这里将生成的水印图案传递给 <code>composite</code> 命令。</li><li><code>-tile</code>：顾名思义，让图案平铺。</li><li><code>-dissolve</code>：设置平铺图案的透明度。</li></ul><p>图释：</p><p><img src="https://img20.360buyimg.com/ling/jfs/t21091/171/680652696/44636/6ceaa42c/5b161da0Nf2158787.jpg" alt="图片描述"></p><h4 id="3、绘制验证码" class="post-heading"><a href="#3、绘制验证码" class="headerlink" title="3、绘制验证码"></a>3、绘制验证码<a class="post-anchor" href="#3、绘制验证码" aria-hidden="true"></a></h4><p>大概逻辑如下：</p><ol><li>随机生成 <code>4</code> 个英文字母或数字。</li><li>创建一个宽高 <code>100x40</code> 的画布。</li><li>设置字体大小为 <code>16</code>，每个字符的宽高也就是 <code>16</code> 左右了，依次计算出每个字符的 <code>x, y</code> 坐标，再增加一丁点旋转。</li><li>随机创建一条透明曲线，加上噪点，增加图片被破解的难度（在保证肉眼能看得清楚的用户体验下）。</li><li>如果需要安全性更高的验证码，请了解验证码破解原理并做合理调整。</li></ol><p>如果加上随机计算，可能代码会比较多，所以这里写成固定值，方便理解。</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">convert  <span class="string">'xc:[100x40!]'</span>  -pointsize <span class="number">20</span>  -font <span class="string">'cochin.ttc'</span>  \</span><br><span class="line">-gravity NorthWest  -strokewidth <span class="number">1</span>  \</span><br><span class="line">-<span class="built_in">fill</span> <span class="string">'#b72b36'</span>  -<span class="built_in">stroke</span> <span class="string">'#b72b36'</span>  -<span class="title">draw</span> <span class="string">'translate 13,19  rotate 10  text -5,-8 "5"'</span>  \</span><br><span class="line">-<span class="built_in">fill</span> <span class="string">'#821d70'</span>  -<span class="built_in">stroke</span> <span class="string">'#821d70'</span>  -<span class="title">draw</span> <span class="string">'translate 36,13  rotate -8  text -8,-8 "C"'</span>  \</span><br><span class="line">-<span class="built_in">fill</span> <span class="string">'#c7960a'</span>  -<span class="built_in">stroke</span> <span class="string">'#c7960a'</span>  -<span class="title">draw</span> <span class="string">'translate 60,23  rotate 5   text -5,-8 "2"'</span>  \</span><br><span class="line">-<span class="built_in">fill</span> <span class="string">'#03610a'</span>  -<span class="built_in">stroke</span> <span class="string">'#03610a'</span>  -<span class="title">draw</span> <span class="string">'translate 85,25  rotate 13  text -8,-8 "E"'</span>  \</span><br><span class="line">-strokewidth <span class="number">2</span>  -<span class="built_in">stroke</span> <span class="string">'rgba(248, 100, 30, 0.5)'</span>  -<span class="built_in">fill</span> <span class="string">'rgba(0, 0, 0, 0)'</span>  \</span><br><span class="line">-<span class="title">draw</span> <span class="string">'bezier  -20,30  -16,10  20,2    50,20'</span>  \</span><br><span class="line">-<span class="title">draw</span> <span class="string">'bezier  50,20   78,42   138,36  140,16'</span>  \</span><br><span class="line">+<span class="built_in">noise</span> Impulse  \</span><br><span class="line">captcha.jpg</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://img10.360buyimg.com/ling/jfs/t20143/186/680399623/7216/bd166545/5b161aefN83150dd6.jpg" alt="图片描述"></p><p>鉴于字体比较细，可以用 <code>strokewidth</code> 加边框来加粗，或者使用字体的粗体版本，这里使用了第一种方式。</p><p>解释：</p><ul><li><code>xc:[100x40!]</code>：设置画布大小的一种简写方式，方括号里写入画布宽高，注意要加 <code>!</code>，否则会出乎意料哟。</li><li><code>文本定位与旋转</code><ol><li>画布宽 <code>100px</code>，平均分成 <code>4</code> 分，每份 <code>25px</code>, 文字宽 <code>16px</code>, 得文字 <code>x</code> 的坐标左右摆动范围为 <code>+0px, +9px</code>，<code>y</code> 坐标同理，用于设置 <code>translate</code> 值。</li><li>实际上字体本身并没有填充满整个 <code>16x16</code> 的区域，根据字体的不同，填满的区域可能各有不同，所以根据<code>cochin</code> 字体的特性，上面稍微将字体大小调整为 <code>20</code>，实际渲染出来的字母才是 <code>16x16</code> 左右大小，数字大概是 <code>10x16</code>，所以设置数字的 <code>x,y</code> 为 <code>-5,-8</code>，结合下面两个属性解释 <code>x,y</code> 的计算方式。</li><li><code>translate</code>: 设置文本的横纵向偏移值。</li><li><code>rotate</code>：设置文本旋转，单位 <code>degrees</code>。根据 <code>gravity</code> 的设置坐标系统有一丁点变化，所以请设置为 <code>西北(NorthWest)</code> ，表示以画布 <code>0,0</code> 坐标旋转，跟 <code>HTML 5 Canvas</code> 坐标系统一致。</li><li>根据这样的坐标系统，如果要文字按自身的中心旋转，得配合 <code>translate</code> 和 <code>text</code> 的 <code>x,y</code> 一起使用，原理可参考<a href="https://aotu.io/notes/2017/05/25/canvas-img-rotate-and-flip/index.html">这篇文章[图像旋转的实现]</a>，注意 <code>translate</code> 与 <code>rotate</code> 的顺序。</li></ol></li><li><code>strokewidth</code>：设置文本的边框宽度或线条宽度。</li><li><code>stroke</code>：设置文本的边框颜色或线条颜色。</li><li><code>-fill &#39;rgba(0, 0, 0, 0)&#39;</code>：上面设置了文本的填充颜色，会影响下面的贝塞尔曲线，所以这里指定一个透明的填充色以覆盖上面的设定，使曲线没有填充。</li><li><code>bezier</code>：绘制贝塞尔曲线，一两句话我怕解释不清楚，所以请大家参考一下<a href="https://en.wikipedia.org/wiki/B%C3%A9zier_curve" target="_blank" rel="noopener">维基百科的解释</a>或者<a href="http://www.html-js.com/article/1628" target="_blank" rel="noopener">这篇中文文章的解释</a>，最后再参考一下 <a href="https://www.imagemagick.org/Usage/draw/#bezier" target="_blank" rel="noopener">IM 官方示例的描述</a>。上面两条三次贝塞尔曲线的坐标分别表示 <code>起始点</code>，<code>起始点的控制点</code>，<code>结束点的控制点</code>，<code>结束点</code>。</li><li><code>+noise</code>：增加噪点，可以使用 <code>convert -list noise</code> 查看当前系统支持哪些算法的噪点，大概有 <code>Gaussian, Impulse, Laplacian, Multiplicative, Poisson, Random, Uniform</code>。</li></ul><h4 id="4、克隆及拼合图像" class="post-heading"><a href="#4、克隆及拼合图像" class="headerlink" title="4、克隆及拼合图像"></a>4、克隆及拼合图像<a class="post-anchor" href="#4、克隆及拼合图像" aria-hidden="true"></a></h4><blockquote><p>这个案例主要了解几个基本操作的 <code>API</code>。</p></blockquote><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">convert  \</span><br><span class="line">\(  -crop <span class="number">300</span>x300+<span class="number">10</span>+<span class="number">25</span>  joy.jpg  \)  \</span><br><span class="line">\(  -resize <span class="number">400</span>x400  -crop <span class="number">300</span>x300+<span class="number">50</span>+<span class="number">0</span>  logo:  \)  -swap <span class="number">0</span>,<span class="number">1</span>  +append  \</span><br><span class="line">\(  -clone <span class="number">0</span>  -flop  -flip  \)  -append  \</span><br><span class="line">-resize <span class="number">200</span>x200  combined.jpg</span><br></pre></td></tr></table></figure><p>结果如下：</p><p><img src="https://img13.360buyimg.com/ling/jfs/t20998/239/710863618/17515/6d03d48b/5b161aedN50ba4b89.jpg" alt="图片描述"></p><p>解释：</p><ul><li><code>圆括号 \( ... \)</code>：图像堆栈 ( <code>image stack</code> )，相当于创建了一个独立作用域处理图像，这个可以使图像之前的处理互不干扰。圆括号需用反斜杠转义，才能不被 <code>Shell</code> 当做特殊字符处理，并且<code>每个圆括号两边需要用空格隔开</code>。不必要的圆括号会使 <code>IM</code> 增加少许额外的工作，但是却让命令更清晰不容易出错。</li><li><code>-crop</code>：裁剪出图像的一个或多个矩形区域，格式为 <code>{size}{+-}x{+-}y</code>，如果不指定偏移值 <code>x,y</code>，则会被解释为按指定宽高切割图像成多少份（多图像）。</li><li><code>logo:</code>：<code>IM</code> 内置图像，这个就是上图中拿着魔法棒的主人公了，本身宽高 <code>640x480</code>，其他内置图像还有：<code>rose:</code>，<code>granite:</code>等，<a href="https://www.imagemagick.org/script/formats.php#builtin-images" target="_blank" rel="noopener">看这里</a>。</li><li><code>-swap</code>：<ol><li>交换图像的位置，格式 <code>-swap index,index</code>。</li><li><code>IM</code> 在图像处理操作时，实际上很可能是在处理一个图像列表，当新图像被读入或者创建时，<code>IM</code> 会将该新图像添加到当前图像列表的末尾。</li><li>如上，本来我们的图像列表里有 <code>2</code> 张图，第一张是 <code>joy</code>，但是 <code>-swap 0,1</code> 的意思是交换第一张图与第二张图的位置，所以 <code>joy</code> 变成跑到后面了。</li></ol></li><li><code>+append</code>：水平连接当前图像列表的图像来创建单个较长的图像。</li><li><code>-append</code>：垂直连接当前图像列表的图像来创建单个较长的图像。</li><li><code>-clone</code>：克隆图像，格式为 <code>-clone {index_range_list}</code>。<ul><li><code>-clone 0</code>：表示克隆图像列表里的第一张图像。</li><li><code>-clone 1-2</code>：表示克隆图像列表里的第二张到第三张图像。</li><li><code>-clone 0--1</code>：<code>0</code> 表示第一张图像，<code>-1</code> 表示最后一张图像，所以整句命令则表示克隆整个图像列表。</li><li><code>-clone 2,0,1</code>：表示克隆第三张，第一张，第二张图像，顺序根据指定的索引决定，用逗号分隔。</li></ul></li><li><code>-flop</code>：将图像水平翻转。</li><li><code>-flip</code>：将图像垂直翻转。</li></ul><p><code>笔记：</code></p><ol><li>选项之间的顺序很重要。</li><li>与 <code>-clone</code> 雷同的选项还有诸如：<code>-delete, -insert, -reverse, -duplicate</code>，用于操作图像列表，功能与单词意思相同。</li></ol><h4 id="5、GIF-与图片互转" class="post-heading"><a href="#5、GIF-与图片互转" class="headerlink" title="5、GIF 与图片互转"></a>5、GIF 与图片互转<a class="post-anchor" href="#5、GIF-与图片互转" aria-hidden="true"></a></h4><h4 id="5-1、GIF-转图片" class="post-heading"><a href="#5-1、GIF-转图片" class="headerlink" title="5.1、GIF 转图片"></a>5.1、GIF 转图片<a class="post-anchor" href="#5-1、GIF-转图片" aria-hidden="true"></a></h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">convert</span>  <span class="selector-tag">-coalesce</span>  <span class="selector-tag">rain</span><span class="selector-class">.gif</span>  <span class="selector-tag">frame</span><span class="selector-class">.jpg</span></span><br></pre></td></tr></table></figure><p><code>-coalesce</code>：根据图像 <code>-dispose</code> 元数据的设置覆盖图像序列中的每个图像，以重现动画序列中每个点的动画效果。下面用一张结果对比图来解释这句话。</p><p>原始图 ( rain.gif ) ：</p><p><img src="https://sfault-image.b0.upaiyun.com/217/323/2173239304-5b13729a9441a_articlex" alt="图片描述"></p><p>结果对比：</p><p><img src="https://img11.360buyimg.com/ling/jfs/t21829/207/694662510/406338/15330984/5b161affN1867e1c9.jpg" alt="图片描述"></p><h4 id="5-2、定义输出文件名" class="post-heading"><a href="#5-2、定义输出文件名" class="headerlink" title="5.2、定义输出文件名"></a>5.2、定义输出文件名<a class="post-anchor" href="#5-2、定义输出文件名" aria-hidden="true"></a></h4><p>上面默认输出的文件名为：<code>frame-0.jpg, frame-1.jpg, frame-2.jpg ...</code>，<br>如果想使用下划线作为符号，输出为 <code>frame_0.jpg, frame_1.jpg, frame_2.jpg ...</code>，则可以如下设置。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">convert</span>  <span class="selector-tag">-coalesce</span>  <span class="selector-tag">rain</span><span class="selector-class">.gif</span>  <span class="selector-tag">frame_</span>%<span class="selector-tag">d</span><span class="selector-class">.jpg</span></span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert  -coalesce  -<span class="keyword">set</span> filename:n <span class="comment">'%p'</span><span class="comment">  rain.gif</span>  <span class="comment">'frame_%[filename:n].jpg'</span></span><br></pre></td></tr></table></figure><p>解释：</p><ol><li>第一种方式 <code>%d</code> 是 <code>C</code> 语言 <code>printf()</code> 中表示输出一个整数，参考 <a href="https://www.imagemagick.org/script/command-line-options.php?#adjoin" target="_blank" rel="noopener">-adjoin</a> 选项。</li><li>第二种为常规方式。<ul><li><code>-set</code>：设置图像属性，格式为 <code>-set key value</code></li><li><code>filename:n &#39;%p&#39;</code>：以 <code>filename:</code> 开头的 <code>key</code> 用于设置输出文件名的相关信息，如这里使用 <code>filename:n</code>，在输出文件名时，则可以使用 <code>%[filename:n]</code> 拿到刚刚的设置，而设置的内容则是 <code>&#39;%p&#39;</code>。<code>&#39;%p&#39;</code> 表示图像在图像列表中的索引值，更多<a href="http://imagemagick.org/script/escape.php" target="_blank" rel="noopener">百分比选项 ( Percent Escapes )</a> 参考。</li></ul></li></ol><h4 id="5-3、解析特定帧" class="post-heading"><a href="#5-3、解析特定帧" class="headerlink" title="5.3、解析特定帧"></a>5.3、解析特定帧<a class="post-anchor" href="#5-3、解析特定帧" aria-hidden="true"></a></h4><p>如果只想拿到 GIF 的第一帧，可以这样设置。</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">convert</span>  -coalesce  <span class="string">'rain.gif[0]'</span>  first_frame.jpg</span><br></pre></td></tr></table></figure><p>拿到某些帧，如同 <code>-clone</code> 的写法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert  -coalesce  <span class="string">'rain.gif[0-2]'</span>  some_frames_%d.jpg</span><br></pre></td></tr></table></figure><h4 id="5-4、获取页数" class="post-heading"><a href="#5-4、获取页数" class="headerlink" title="5.4、获取页数"></a>5.4、获取页数<a class="post-anchor" href="#5-4、获取页数" aria-hidden="true"></a></h4><p>通过 <code>identify</code> 命令我们可以简要得到文件的信息，如下。<br></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">identify</span>  <span class="selector-tag">rain</span><span class="selector-class">.gif</span></span><br></pre></td></tr></table></figure><p></p><p><img src="https://img11.360buyimg.com/ling/jfs/t21955/234/742104977/71488/5b55a29f/5b1665d4Nfe4bd0aa.png" alt="get_pages.png"></p><p>通过换行符分割，简单封装一个 <code>Node.js</code> 函数获取页数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parser.js</span></span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>)</span><br><span class="line"><span class="keyword">const</span> exec = util.promisify(<span class="built_in">require</span>(<span class="string">'child_process'</span>).exec)</span><br><span class="line"></span><br><span class="line">exports.numberOfPages = <span class="keyword">async</span> (filePath) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; stdout &#125; = <span class="keyword">await</span> exec(<span class="string">`identify '<span class="subst">$&#123;filePath&#125;</span>'`</span>)</span><br><span class="line">    <span class="keyword">return</span> stdout.trim().split(<span class="string">'\n'</span>).length</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; numberOfPages &#125; = <span class="built_in">require</span>(<span class="string">'./parser'</span>)</span><br><span class="line"></span><br><span class="line">;(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> pages = <span class="keyword">await</span> numberOfPages(<span class="string">'rain.gif'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'pages:'</span>, pages)</span><br><span class="line">&#125;())</span><br></pre></td></tr></table></figure><h4 id="5-5、图片转-GIF" class="post-heading"><a href="#5-5、图片转-GIF" class="headerlink" title="5.5、图片转 GIF"></a>5.5、图片转 GIF<a class="post-anchor" href="#5-5、图片转-GIF" aria-hidden="true"></a></h4><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert  -<span class="keyword">loop</span> <span class="number">0</span>  <span class="symbol">'frame</span>-*.jpg'  rain_animation.gif</span><br></pre></td></tr></table></figure><p>将所有与 <code>frame-*.jpg</code> 模式匹配的图像转换成一张 <code>GIF</code> 图像，如 <code>frame-0.jpg</code>，<code>frame-1.jpg</code>等。<br><code>-loop</code> 设置动画循环次数，<code>0</code> 表示无限循环。<br>设置每张图像的播放速度可以使用 <a href="https://www.imagemagick.org/Usage/anim_basics/#gif_anim" target="_blank" rel="noopener">-delay</a> 选项。</p><p><code>笔记：</code> 在 <code>IM</code> 读取系列文件时，<code>frame-10.jpg</code> 会排在 <code>frame-2.jpg</code> 前面，为获得图像正确的读取顺序，可以为文件名设置前导零 ( <code>leading zeros</code> )。如：<code>frame-000.jpg, frame-001.jpg, frame-002.jpg ... frame-010.jpg</code>。</p><p>所以在生成图像时，我们可以使用 <code>%03d</code> 获得三位前导零。<br></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">convert</span>  <span class="selector-tag">-coalesce</span>  <span class="selector-tag">rain</span><span class="selector-class">.gif</span>  <span class="selector-tag">frame-</span>%03<span class="selector-tag">d</span><span class="selector-class">.jpg</span></span><br></pre></td></tr></table></figure><p></p><h4 id="6、PDF-与图片互转" class="post-heading"><a href="#6、PDF-与图片互转" class="headerlink" title="6、PDF 与图片互转"></a>6、PDF 与图片互转<a class="post-anchor" href="#6、PDF-与图片互转" aria-hidden="true"></a></h4><p>PDF 与图片互转跟 GIF 很相似，稍微有些格式自身需要注意的区别。<br><code>IM</code> 本身是不具备解析 PDF 的功能的，需要依赖专门解析这种格式的外部程序，如官方指明的 <code>ghostscript</code> 解析程序。<br>首先安装 <code>gs</code>，还是演示 <code>Mac OS</code> 安装：<code>brew install ghostscript</code>。</p><p>以 <a href="https://mozilla.github.io/pdf.js/web/viewer.html" target="_blank" rel="noopener">这个PDF</a> 为例，把它转换成图片，有两种方式达到我们想要的结果:<br></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">① convert  -density <span class="number">150</span>  -<span class="keyword">flatten</span>  <span class="string">'download.pdf[0]'</span>  first_page.jpg</span><br></pre></td></tr></table></figure><p></p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">② <span class="built_in">convert</span>  -density <span class="number">150</span>  -<span class="built_in">background</span> white  -alpha <span class="built_in">remove</span>  download.pdf  download.jpg</span><br></pre></td></tr></table></figure><p>解释：</p><ol><li>当转换 PDF 成 JPG 格式图像时，某些情况得到的 JPG 图片会出现黑色背景（转换成 PNG 不会），所以可以使用 <code>-flatten</code> 选项让其保持白色背景，但加上这个选项，<code>多页 PDF 不会分成多个 JPG 图像</code>，第二种方式 <code>-background white -alpha remove</code> 则可以<code>一次命令转换多页 PDF 成多个图像</code>并保持白色背景。</li><li>第二种方式 <code>IM</code> 内部应该是一页一页的转换，所以一个 <code>10</code> 页的 <code>PDF</code> 耗时会比较久，采用第一种方式让 <code>Node.js</code> 多进程同时转换该 <code>PDF</code> 可以提升速率。</li><li><code>-density</code>：指定输出图像的分辨率 ( <code>DPI</code> )，在 <code>Mac OS</code> 上，默认的分辨率 ( <code>72</code> ) 输出的图像字迹不清，需要更高分辨率获得清晰的图像。</li></ol><h3 id="在-Node-js-中应用" class="post-heading"><a href="#在-Node-js-中应用" class="headerlink" title="在 Node.js 中应用"></a>在 Node.js 中应用<a class="post-anchor" href="#在-Node-js-中应用" aria-hidden="true"></a></h3><blockquote><p>直接通过 <code>child_process</code> 模块执行相应的命令即可，如下。</p></blockquote><p>只需要结果可以使用 <code>exec</code>，<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>)</span><br><span class="line"><span class="keyword">const</span> exec = util.promisify(<span class="built_in">require</span>(<span class="string">'child_process'</span>).exec)</span><br><span class="line"></span><br><span class="line">;(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> exec(<span class="string">`convert -resize '150x100!' -strip goods.jpg thumbnail.jpg`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'convert completed.'</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'convert failed.'</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;())</span><br></pre></td></tr></table></figure><p></p><p>流式输入输出可以使用 <code>spawn</code>，<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cp = <span class="built_in">require</span>(<span class="string">'child_process'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> args = [</span><br><span class="line">  <span class="string">'-'</span>,  <span class="comment">// 使用标准输入</span></span><br><span class="line">  <span class="string">'-resize'</span>, <span class="string">'150x100!'</span>,</span><br><span class="line">  <span class="string">'-strip'</span>,</span><br><span class="line">  <span class="string">'jpg:-'</span>,  <span class="comment">// 输出到标准输出</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> streamIn = fs.createReadStream(<span class="string">'/path/to/goods.jpg'</span>)</span><br><span class="line"><span class="keyword">const</span> proc = cp.spawn(<span class="string">'convert'</span>, args)</span><br><span class="line">streamIn.pipe(proc.stdin)</span><br><span class="line">proc.stdout.pipe(HttpResponse)</span><br></pre></td></tr></table></figure><p></p><div class="post-tags" style="display:none"><a href="/tags/图像处理/">图像处理</a> <a href="/tags/ImageMagick/">ImageMagick</a> <a href="/tags/linux/">linux</a> <a href="/tags/node-js/">node.js</a></div><div class="post-categories" style="display:none"><a href="/cates/Web开发/">Web开发</a></div><div class="post-announce">感谢您的阅读，本文由 <a href="//aotu.io">凹凸实验室</a> 版权所有。如若转载，请注明出处：凹凸实验室（<a href="https://aotu.io/notes/2018/06/06/ImageMagick_intro/">https://aotu.io/notes/2018/06/06/ImageMagick_intro/</a>）</div><div class="post-revision"><i class="fa fa-clock-o"></i> <time class="post-updated" datetime="2021-02-02T07:48:05.246Z">上次更新：2021-02-02 15:48:05</time></div></div><div class="post-nav"><div class="post-nav-next"><a href="/notes/2018/06/07/Taro/" title="多端统一开发框架 - Taro">多端统一开发框架 - Taro <i class="fa fa-chevron-right"></i></a></div><div class="post-nav-prev"><a href="/notes/2018/04/24/jdindex_2017/" title="Nerv实战 - 京东首页改版小结"><i class="fa fa-chevron-left"></i> Nerv实战 - 京东首页改版小结</a></div></div><div class="post-comments" id="comments"></div><script>var gitalkOpts={id:"bm90ZXMvMjAxOC8wNi8wNi9JbWFnZU1hZ2lja19pbnRyby8=",owner:"o2team",repo:"o2team.github.io",title:"图像处理 - ImageMagick 简单介绍与案例",body:"https://aotu.io/notes/2018/06/06/ImageMagick_intro/index.html\n\nImageMagick 是一款创建、编辑、合成，转换图像的命令行工具。支持格式超过 200 种，包括常见的 PNG, JPEG, GIF, HEIC, TIFF, DPX, EXR, WebP, Postscript, PDF, SVG 等。功能包括调整，翻转，镜像(mirror)，旋转，扭曲，修剪和变换图像，调整图像颜色，应用各种特殊效果，或绘制文本，线条，多边形，椭圆和贝塞尔曲线等。本文主要介绍一下 ImageMagick 的用法与细节。",clientID:"3c4d153e6874260f9c7e",clientSecret:"dd44012504c6168bc05b9266e0554bb28c62ce15",admin:["Barrior"]}</script></article></div><aside class="mod-side" id="sidebar"><div class="mod-side-sec aotuwx"><img class="aotuwx-qrcode" src="/img/qrcode.jpg" alt="关注我们"><div class="aotuwx-slogan">每周推送精选技术文章</div></div><div class="mod-side-sec works"><div class="mod-side-sec-hd"><h2>服务/产品</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="//taro.jd.com" target="_blank" title="Taro">Taro</a></li><li><a href="//taro-ui.jd.com" target="_blank" title="Taro-UI">Taro-UI</a></li><li><a href="//taro-ext.jd.com" target="_blank" title="Taro 物料市场">Taro 物料市场</a></li><li><a href="//taro-club.jd.com" target="_blank" title="Taro 官方论坛">Taro 官方论坛</a></li><li><a href="//cases.aotu.io/mobi/maga.html" target="_blank" title="拇指期刊">拇指期刊</a></li><li><a href="//athena.aotu.io/" target="_blank" title="Athena">Athena</a></li><li><a href="//guide.aotu.io/" target="_blank" title="前端代码规范">前端代码规范</a></li><li><a href="//halojs.aotu.io/" target="_blank" title="HaloJS">HaloJS</a></li><li><a href="//sign.aotu.io/" target="_blank" title="邮件签名工具">邮件签名工具</a></li><li><a href="//mac.aotu.io/" target="_blank" title="MAC全栈环境">MAC全栈环境</a></li><li><a href="//xcel.aotu.io" target="_blank" title="Excel Filter">Excel Filter</a></li><li><a href="//aotu.jd.com/share/" target="_blank" title="凹凸公开课">凹凸公开课</a></li><li><a href="//at.aotu.io" target="_blank" title="AT-UI">AT-UI</a></li></ul></div></div><div class="mod-side-sec favlinks"><div class="mod-side-sec-hd"><h2>友情链接</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="https://www.cloudbase.net" target="_blank" title="小程序·云开发"><img style="width:22px;vertical-align:middle" src="https://img20.360buyimg.com/ling/jfs/t1/57175/5/15617/50216/5dca6729E00cdff5d/631622525425290e.png">小程序·云开发</a></li><li><a href="https://ling.jd.com" target="_blank" title="京东羚珑智能设计">羚珑智能设计</a></li><li><a href="https://jdrd.jd.com" target="_blank" title="京东零售设计服务平台">京东零售设计服务平台</a></li><li><a href="https://jdc.jd.com" target="_blank" title="京东设计中心">JDC京东设计中心</a></li><li><a href="http://dopro.io/" target="_blank" title="腾讯 Deep Ocean">Deep Ocean</a></li><li><a href="http://fex.baidu.com" target="_blank" title="百度Web前端研发部">百度FEX</a></li><li><a href="http://taobaofed.org" target="_blank" title="淘宝前端团队">淘宝FED</a></li><li><a href="http://tgideas.qq.com" target="_blank" title="腾讯互娱设计中心">TGIdeas</a></li><li><a href="http://isux.tencent.com" target="_blank" title="腾讯SNG设计中心">ISUX</a></li><li><a href="http://cdc.tencent.com" target="_blank" title="腾讯用户研究与体验设计中心">CDC</a></li><li><a href="http://ued.ctrip.com" target="_blank" title="携程设计委员会">携程UED</a></li><li><a href="https://uiiiuiii.com/" target="_blank" title="优优教程网">优优教程网</a></li><li><a href="https://www.designup.cn/" target="_blank" title="Designup">Designup</a></li><li><a href="http://eux.baidu.com/" target="_blank" title="百度EUX">百度EUX</a></li></ul></div></div></aside></div></div><div class="mod-backtop" id="backTop"><i class="fa fa-long-arrow-up"></i></div><footer class="mod-ft" id="footer"><div class="grid"><ul class="mod-ft-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="https://github.com/o2team/o2team.github.io" target="_blank"><i class="fa fa-github-alt"></i></a></li></ul><div class="mod-ft-sec mod-ft-copyright"><p>Designed by <a href="http://aotu.io" target="_blank">凹凸实验室</a> @<a target="_blank" href="http://jdc.jd.com">京东用户体验设计部</a></p><p>Copyright &copy; 2021. All Rights Reserved.</p><p><a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备15077732号-2</a></p></div></div></footer><script src="/js/bundle/core.js"></script><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/post_wx_share.js"></script><script src="/js/bundle/gitalk.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e850b980d029480b092fdd7503c3f8de";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript" src="https://tajs.qq.com/stats?sId=53685723" charset="UTF-8"></script></body></html>