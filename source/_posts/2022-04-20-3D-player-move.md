---
title: 3D æ²™ç›’æ¸¸æˆä¹‹äººç‰©çš„ç‚¹å‡»è¡Œèµ°ç§»åŠ¨
subtitle: è®²è¿°å®ç°â€œç‚¹å‡»åœ°é¢ï¼Œäººç‰©ç§»åŠ¨åˆ°ç‚¹å‡»å¤„â€åŠŸèƒ½ï¼Œéœ€è¦çš„å‰ç½®æ¡ä»¶åŠå…¶å…·ä½“å®ç°æ€è·¯ã€æ­¥éª¤
cover: https://img10.360buyimg.com/ling/jfs/t1/164213/26/22846/233034/625fb53bE076fcac0/d1679972049705f3.jpg
categories: Webå¼€å‘
tags:
  - 3D
  - 3Dæ¨¡å‹
author:
  nick: èµ›ç±³è€å†¯
  github_name: sm450203924
date: 2022-04-20 16:16:00
wechat:
  share_cover: https://img12.360buyimg.com/ling/jfs/t1/195291/33/23550/129115/625fb53bE7f03d831/457bd45709999821.jpg
  share_title: 3D æ²™ç›’æ¸¸æˆä¹‹äººç‰©çš„ç‚¹å‡»è¡Œèµ°ç§»åŠ¨
  share_desc: è®²è¿°å®ç°â€œç‚¹å‡»åœ°é¢ï¼Œäººç‰©ç§»åŠ¨åˆ°ç‚¹å‡»å¤„â€åŠŸèƒ½ï¼Œéœ€è¦çš„å‰ç½®æ¡ä»¶åŠå…¶å…·ä½“å®ç°æ€è·¯ã€æ­¥éª¤
---
# 3D æ²™ç›’æ¸¸æˆä¹‹äººç‰©çš„ç‚¹å‡»è¡Œèµ°ç§»åŠ¨

åœ¨ 3D æ¸¸æˆä¸­ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªä¸»äººå…¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‚¹å‡»æ¸¸æˆä¸­çš„å…¶ä»–ä½ç½®ï¼Œä½¿æ¸¸æˆä¸»äººå…¬å‘ç‚¹å‡»å¤„ç§»åŠ¨ã€‚

é‚£å½“æˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ªâ€œç‚¹å‡»åœ°é¢ï¼Œäººç‰©ç§»åŠ¨åˆ°ç‚¹å‡»å¤„â€çš„åŠŸèƒ½ï¼Œéœ€è¦ä»€ä¹ˆå‰ç½®æ¡ä»¶ï¼Œå¹¶ä¸”å…·ä½“æ€ä¹ˆå®ç°å‘¢ï¼Ÿæœ¬æ–‡å¸¦å¤§å®¶ä¸€æ­¥æ­¥å®ç°äººç‰©è¡Œèµ°ç§»åŠ¨ï¼ŒåŒæ—¶è¿›è¡ŒçŠ¶æ€æ”¹å˜çš„åŠŸèƒ½ã€‚

<br >

## ä¸€ã€éª¨éª¼åŠ¨ç”»

**éª¨éª¼åŠ¨ç”»**ï¼ˆSkeleton animation åˆç§°éª¨æ¶åŠ¨ç”»ï¼Œæ˜¯ä¸€ç§è®¡ç®—æœºåŠ¨ç”»æŠ€æœ¯ï¼Œå®ƒå°†ä¸‰ç»´æ¨¡å‹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç”¨äºç»˜åˆ¶æ¨¡å‹çš„è’™çš®ï¼ˆSkinï¼‰ï¼Œä»¥åŠç”¨äºæ§åˆ¶åŠ¨ä½œçš„éª¨æ¶ã€‚

ä¸€èˆ¬åœ¨ 3D æ¸¸æˆä¸­çš„ä¸»äººå…¬ï¼Œå®ƒçš„è·‘æ­¥ã€èµ°è·¯ã€ç«™ç«‹çš„åŠ¨ä½œï¼Œéƒ½æ˜¯æ¨¡å‹æ–‡ä»¶çš„è‡ªå¸¦éª¨éª¼åŠ¨ç”»ã€‚

**éª¨éª¼åŠ¨ç”»æƒé‡**
æ”¹å˜éª¨éª¼åŠ¨ç”»çš„æƒé‡ï¼Œå¯ä»¥ä½¿å¾—åŠ¨ç”»é—´çš„è¿‡æ¸¡æ›´ä¸ºè‡ªç„¶ã€‚æ¯”å¦‚ä½“æµ‹æ—¶ï¼Œå½“ä½ åˆ°è¾¾ç»ˆç‚¹åï¼Œä¼šé€æ¸å‡æ…¢é€Ÿåº¦ï¼Œè·‘æ­¥åŠ¨ä½œçš„å¹…åº¦è¶Šæ¥è¶Šå°ï¼Œç„¶åå˜æˆèµ°è·¯ï¼Œæœ€ååœæ­¢ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ä¸€ä¸ªä¿©åŠ¨ä½œæƒé‡æ¸å˜çš„ä¾‹å­ï¼š
![](https://img12.360buyimg.com/ling/jfs/t1/179436/33/21869/341962/6232a39fE84b9bb52/79c7153ffb05ae6d.jpg)

è¿™ä¸ªä¾‹å­ä¸­ï¼Œä»ä¼‘é—²å˜åˆ°èµ°è·¯ï¼Œä¼‘é—²åŠ¨ç”»çš„æƒé‡ä»1åˆ°0é€’å‡ï¼ŒåŒæ—¶èµ°è·¯åŠ¨ç”»çš„æƒé‡ä»0åˆ°1é€’å¢ã€‚å¯ä»¥çš„ç‚¹å‡»ğŸ‘‰ [è¿™ä¸ªç½‘ç«™ä¸­ > Crossfading > from idle to walk](https://threejs.org/examples/webgl_animation_skinning_blending.html) ä½“éªŒä¸€ä¸‹ã€‚

åœ¨æœ¬æ¬¡ 3D æ²™ç›’æ¸¸æˆä¸­ï¼Œäººç‰©çŠ¶æ€æ”¹å˜ï¼Œä¸»è¦æ˜¯é¼ æ ‡ç‚¹å‡»åœ°é¢åï¼Œäººç‰©ä»ä¼‘é—²çŠ¶æ€è½¬ä¸ºè·‘æ­¥çŠ¶æ€ï¼Œå½“äººç‰©åˆ°è¾¾ç›®çš„åœ°åï¼Œåˆå˜ä¸ºä¼‘é—²çŠ¶æ€ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™äº›çŠ¶æ€æ”¹å˜æ˜¯å¦‚ä½•å®ç°çš„ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡å¸ˆæä¾›ä¸€ä¸ªæ‹¥æœ‰éª¨éª¼åŠ¨ç”»çš„æ¨¡å‹ï¼Œå®ƒæœ‰ä¸¤ä¸ªéª¨éª¼åŠ¨ç”»ï¼Œä¸€ä¸ªä¸ºä¼‘é—²ï¼ˆidleï¼‰çŠ¶æ€ï¼Œä¸€ä¸ªä¸ºè·‘æ­¥ï¼ˆrunï¼‰çŠ¶æ€ã€‚


### 1.1 æ€è·¯
![](https://img13.360buyimg.com/ling/jfs/t1/116318/38/21155/86770/6231fdf4Edf23a55b/87756695ee6da7a8.png)

<br >

### 1.2 åŠ¨ç”»åˆå§‹åŒ–
å…ˆè®©æˆ‘ä»¬å°†éª¨éª¼åŠ¨ç”»ã€åŠ¨ç”»åç§°ã€æƒé‡æ”¾åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­å­˜å‚¨èµ·æ¥ï¼Œ
```
idleAnimConfig = {
  name: string;
  anim: AnimationGroup;
  weight: number;
}
```

é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­æ˜¯å¦æ­£åœ¨è¡Œèµ°å‘¢ï¼Ÿå°±éœ€è¦ä¸€ä¸ªå½“å‰åŠ¨ç”»çš„ flagï¼Œåˆå§‹åŒ–æ—¶å°† idle è®¾ä¸ºå½“å‰åŠ¨ç”»
```
currentAnimConfig = idleAnimConfig
```

<br >

### 1.3 åŠ¨ç”»æƒé‡æ”¹å˜
![](https://img12.360buyimg.com/ling/jfs/t1/110333/9/24874/105276/6231fdf4E97464f9a/61be4c2bfce2dd65.png)

å¦‚å›¾ï¼Œæˆ‘ä»¬åœ¨äººç‰©çŠ¶æ€æ”¹å˜æ—¶ï¼Œéœ€è¦å°†å½“å‰çŠ¶æ€çš„åŠ¨ç”»æƒé‡é€’å¢ï¼Œå¦ä¸€çŠ¶æ€çš„åŠ¨ç”»æƒé‡é€’å‡ï¼ˆæ³¨æ„ï¼Œæƒé‡å€¼éœ€è¦é™åˆ¶åœ¨[0, 1]ï¼‰ã€‚è®©æˆ‘ä»¬çœ‹ä¸‹ä¼ªä»£ç ï¼Œå‡è®¾ `deltaWeight` ä¸ºæ­£æ•°
```
changeAnimWeight() {
  // å½“å‰åŠ¨ç”» -> é€’å¢
  if (currentAnimConfig) {
    setAnimationWeight(currentAnimConfig, deltaWeight)
  }
  // å…¶ä»–åŠ¨ç”» -> é€’å‡ï¼Œå¦‚ç«™ç«‹åŠ¨ä½œåˆ‡æ¢åˆ°èµ°è·¯
  if (currentAnimConfig !== idleAnimConfig) {
    setAnimationWeight(idleAnimConfig, -deltaWeight)
  }
  // å…¶ä»–åŠ¨ç”» -> é€’å‡ï¼Œå¦‚èµ°è·¯åŠ¨ä½œåˆ‡æ¢åˆ°ç«™ç«‹
  if (currentAnimConfig !== runAnimConfig) {
    setAnimationWeight(runAnimConfig, -deltaWeight)
  }
}
```

ç„¶ååœ¨ render çš„æ—¶å€™ï¼Œè¿›è¡ŒçŠ¶æ€åˆ‡æ¢
```
onRender() {
  if (å‡†å¤‡åˆ°è¾¾ç›®çš„åœ°) {
    setCurAnimation(runAnimConfig)
  } else {
    setCurAnimation(idleAnimConfig)
  }

  changeAnimWeight()
}
```

<br >

### 1.4 ç¼ºå°‘åŠ¨ç”»
å¦‚æœ animationGroup é‡Œåªæœ‰ä¸€ä¸ª run åŠ¨ç”»æ€ä¹ˆåŠå‘¢ï¼Ÿ
ç­”æ¡ˆè¿˜æ˜¯ä¸€æ ·çš„ï¼Œåªè¦å°† idle åŠ¨ç”»çš„éª¨éª¼åŠ¨ç”»è®¾ä¸º `null` å³å¯ï¼Œåƒè¿™æ ·ï¼š
```
idleAnimConfig = {
  name: string;
  anim: null;
  weight: number;
}
```
è¿™ä¹ˆåšå³ä½¿åæ¥æ›´æ¢äº†å…·æœ‰ä¸¤ä¸ªåŠ¨ç”»çš„äººç‰©æ¨¡å‹ï¼Œä¹Ÿèƒ½å¤ç”¨ã€‚

<br >

**åŠ¨ç”»çŠ¶æ€åˆ‡æ¢å®ç°æ•ˆæœ**

![](https://storage.360buyimg.com/model-rendering-tool/sammy/weight-compress.gif)


<br >
<br >

## äºŒã€è¡Œèµ°ç§»åŠ¨

å½“æˆ‘ä»¬å¹³å¸¸å†™åŠ¨ç”»æ—¶ï¼Œä¼šç”¨åˆ° rAF å¹¶é€’å½’è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œå®ç°ä¸€ä¸ªé€å¸§æ¸²æŸ“åŠ¨ç”»ã€‚å½“äººç‰©è¡Œèµ°åœ¨å¹³åœ°ä¸Šæ—¶ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨é€å¸§ç§»åŠ¨ï¼Œæ¥å®ç°ä¸€ä¸ªä½ç§»çš„åŠ¨ç”»ã€‚ä¾‹å¦‚ Babylon å·²ç»å°è£…å¥½äº†[ render çš„äº‹ä»¶ API](https://doc.babylonjs.com/typedoc/classes/babylon.scene#onbeforerenderobservable)ï¼Œåªè¦æˆ‘ä»¬å°†æ¸²æŸ“åŠ¨ç”»ç»‘å®š render äº‹ä»¶ï¼Œå°±å¯ä»¥ä½¿ç”¨äº†ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹å…·ä½“æ€è·¯ï¼š
![](https://img30.360buyimg.com/ling/jfs/t1/167606/20/27171/149922/6232a6b0E8ba7f07c/ec0f1456ca4f46cb.jpg)

<br >

### 2.1 ç§»åŠ¨
ç”±ä¸Šé¢çš„æ€è·¯å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ç§»åŠ¨çš„æ—¶å€™éœ€è¦ç”¨åˆ°å‡ ä¸ªå˜é‡ï¼š
- è·ç»ˆç‚¹çš„è·ç¦»ï¼ˆdistanceï¼‰
- ç§»åŠ¨çš„æ–¹å‘ï¼ˆdirectionï¼‰

é‚£ä¹ˆå°±éœ€è¦åœ¨ç‚¹å‡»çš„æ—¶å€™ï¼Œè·å–åˆ°è¿™äº›å˜é‡ã€‚distance å¯ä»¥åˆ©ç”¨çŸ©é˜µå¯¹åº”åæ ‡ç›¸åŠ å‡è®¡ç®—ï¼Œdirection å°±æ˜¯ç›®æ ‡ä½ç½®å‡åˆå§‹ä½ç½®çš„æ³•å‘é‡
```
directToPath() {
  // å°†äººç‰©çš„ä½ç½®è®¾ä¸ºåˆå§‹ä½ç½®
  initVec = this.player.position
  // è®¡ç®—åˆå§‹ä½ç½®ä¸ç»ˆç‚¹çš„è·ç¦»
  distance = Distance(targetVec, initVec)

  // å°†ç»ˆç‚¹ä½ç½®ä¸åˆå§‹ä½ç½®ç›¸å‡
  targetVec = targetVec.subtract(initVec)
  // ä½¿ç”¨æ³•å‘é‡è®¡ç®—å‡ºä¸ç»ˆç‚¹çš„æœå‘
  direction = Normalize(targetVec)

  player.lookAt(targetVec)
}

onClick() {
  // ...
  directToPath()
}
```

åœ¨ render çš„æ—¶å€™è¿›è¡Œä½ç§»
```
onRender() {
  if (distance > READY_ARRIVE) {
    distance -= SPEED

    // äººç‰©æœ direction æ–¹å‘ç§»åŠ¨ SPEED è·ç¦»
    player.translate(direction, SPEED, Space.WORLD)
  }
}
```

<br >

**ä½ç§»å®ç°æ•ˆæœ**

![](https://storage.360buyimg.com/model-rendering-tool/sammy/move-compress.gif)

<br >


### 2.2 ç»“åˆåŠ¨ç”»

å½“æˆ‘ä»¬çš„ç§»åŠ¨ç»“åˆæ¨¡å‹çš„éª¨éª¼åŠ¨ç”»

![](https://img10.360buyimg.com/ling/jfs/t1/216623/9/14893/72162/62316f4aEe4ef8765/a26bf421f1afd443.jpg)

è®©æˆ‘ä»¬çœ‹çœ‹ä¼ªä»£ç ï¼š
```
onRender() {
  if (distance > READY_ARRIVE) {
    distance -= SPEED

    // äººç‰©æœ direction æ–¹å‘ç§»åŠ¨ SPEED è·ç¦»
    player.translate(direction, SPEED, Space.WORLD)

    setCurAnimation(runAnimConfig)
  } else {
    setCurAnimation(idleAnimConfig)
  }

  changeAnimWeight()
}
```

<br >

**ä½ç§»åŠçŠ¶æ€å˜åŒ–å®ç°æ•ˆæœ**

![](https://storage.360buyimg.com/model-rendering-tool/sammy/move-weight-compress.gif)

<br >
<br >

## ä¸‰ã€äººç‰©é¿éšœ
### 3.1 æ€è·¯
äººç‰©è¡Œèµ°é¿éšœï¼Œå®é™…ä¸Šå°±æ˜¯ä»èµ·ç‚¹åˆ°ç»ˆç‚¹ï¼Œåœ¨è¿™ä¹‹ä¸­æ·»åŠ äº†**ä¸­é—´ç‚¹**ã€‚å¦‚å›¾
![](https://img10.360buyimg.com/ling/jfs/t1/159290/12/28563/39510/6231f996Ed1b5d277/68c408d3cd39fbe6.png)

æ‰€ä»¥æˆ‘ä»¬åªè¦è®°å½•ä¸‹å½“å‰èµ·ç‚¹åˆ°ç»ˆç‚¹è¿™ä¸ªè·¯å¾„æ•°ç»„ï¼Œæ¯æ¬¡éƒ½æœæ•°ç»„çš„ç¬¬Nä¸ªç‚¹è¡Œèµ°ï¼Œå°±èƒ½åšåˆ°è½¬å‘ã€‚ä¸‹é¢æˆ‘ä»¬æ¥æ ¹æ®æ€è·¯åŠä¼ªä»£ç è¿›è¡Œæ­¥éª¤ç»†åŒ–ã€‚

<br >

(1) è®°å½•è·¯å¾„å’Œåˆå§‹åŒ–å½“å‰çš„è·¯å¾„ç´¢å¼•
```
path = getPath(targetVec)
prePathIdx = 0
```

(2) å½“åˆ°è¾¾å½“å‰ä¸­é—´ç‚¹æ—¶ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ç‚¹ã€‚å½“èµ°åˆ°æœ€åä¸€ä¸ªï¼Œåˆ™åœæ­¢
```
onRender() {
  if (distance > READY_ARRIVE) {
    // ...ç§»åŠ¨åŠåŠ¨ç”»æƒé‡åˆ‡æ¢...
  } else {
    switchPath()
    // ...
  }
  // ...
}

switchPath() {
  prePathIdx += 1
  directToPath()
}

directToPath() {
  const curPath = path[prePathIdx]
  if (!curPath) return

  // ...äººç‰©ç§»åŠ¨åŠè½¬å‘...
}
```

<br >


### 3.2 æ¥å…¥å®é™…é¿éšœç®—æ³•
ç”± **3.1** å¾—çŸ¥ï¼Œäººç‰©çš„è¡Œèµ°ç§»åŠ¨è¦æ¥å…¥é¿éšœç®—æ³•ï¼Œéœ€è¦åˆ©ç”¨åˆ°è¯¥ç®—æ³•æä¾›çš„è·¯å¾„è§„åˆ’æ•°ç»„ã€‚å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠï¼Œä¼ªä»£ç é‡Œçš„`getPath()`æ–¹æ³•ï¼Œæ¢æˆç®—æ³•è®¡ç®—é“è·¯çš„æ–¹æ³•å³å¯ã€‚


#### 3.2.1 RecastJSPlugin
ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ Babylon è‡ªå¸¦çš„ [Recast æ’ä»¶](https://doc.babylonjs.com/extensions/crowdNavigation) ï¼Œæ¥å…·ä½“è¯´æ˜ä¸€ä¸‹å¦‚ä½•æ¥å…¥é¿éšœç®—æ³•ã€‚


**æ–¹æ³• 1**

åœ¨ recast ä¸­ï¼Œå¯ä»¥é€šè¿‡ `computePath` è·å–è·¯å¾„ï¼š
```
const closestPoint = this.navigationPlugin.getClosestPoint(pickedPoint)
const path = this.navigationPlugin.computePath(
  this._crowd.getAgentPosition(0),
  closestPoint
)
```
ç„¶ååˆ©ç”¨ **3.1** çš„æ€è·¯ï¼Œé€šè¿‡è·¯å¾„ç´¢å¼•åˆ‡æ¢è¿›è¡Œç§»åŠ¨ã€‚

<br >

**æ–¹æ³• 2**

recast é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªå¯¼èˆªç½‘æ ¼ï¼Œç„¶åé€šè¿‡æ·»åŠ  `agent` è®©å®ƒä»¬çº¦æŸåœ¨è¿™ä¸ªå¯¼èˆªç½‘æ ¼ä¸­ï¼Œè€Œè¿™äº› `agent` çš„é›†åˆï¼Œç§°ä¸º `crowd`ã€‚

å¹¶ä¸” recast è‡ªå¸¦äº†ç§»åŠ¨çš„ API â€”â€” `agentGoto`ï¼Œæ­¤æ—¶å¯ä»¥ä¸éœ€è¦å†å»è®¡ç®—è·ç¦»å’Œæ–¹å‘ï¼Œå¹¶ä¸”ä¹Ÿä¸éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ç§»åŠ¨è·¯å¾„ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å…·ä½“æ˜¯æ€ä¹ˆåšçš„ã€‚

(1) åˆå§‹åŒ–æ’ä»¶ï¼Œå¹¶è®¾ç½® Web Worker æ¥è·å–ç½‘æ ¼æ•°æ®ä»¥ä¼˜åŒ–æ€§èƒ½
```
initNav() {
  navigationPlugin = new RecastJSPlugin()

  // è®¾ç½®Web Workerï¼Œåœ¨é‡Œé¢è·å–ç½‘æ ¼æ•°æ®
  navigationPlugin.setWorkerURL(WORKER_URL)

  // åˆ›å»ºå¯¼èˆªmesh
  navigationPlugin.createNavMesh([
    ground,
    ...obstacleList, // éšœç¢ç‰©åˆ—è¡¨mesh
  ], NAV_MESH_CONFIG, (navMeshData) => {
    navigationPlugin.buildFromNavmeshData(navMeshData)
  }

  this.navigationPlugin = navigationPlugin
}

```

(2) åˆå§‹åŒ– crowdï¼ˆcrowdï¼šçº¦æŸåœ¨å¯¼èˆªç½‘æ ¼ä¸­ `agent` çš„é›†åˆï¼‰
```
initCrowd() {
  this.crowd = this.navigationPlugin.createCrowd(1, MAX_AGENT_RADIUS, this.scene)

  const transform = new TransformNode('playerTrans')
  this.crowd.addAgent(this.player.position, AGENTS_CONFIG, transform)
}
```

(3) ç‚¹å‡»æ—¶åˆ©ç”¨ `agentGoto` APIè¿›è¡Œç§»åŠ¨ï¼Œ`pickedPoint` ä¸ºç‚¹å‡»ç‚¹çš„ä¸‰ç»´åæ ‡ï¼Œç”±äº crowd é‡Œåªæœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ç´¢å¼•æ˜¯ 0
```
const closestPoint = this.navigationPlugin.getClosestPoint(pickedPoint)
this.crowd.agentGoto(0, closestPoint)
```

(4) åˆ¤æ–­æ˜¯å¦åœæ­¢ï¼Œæœªåœæ­¢åˆ™æ”¹å˜äººç‰©æœå‘

é‚£ä¹ˆå¦‚ä½•æ”¹å˜äººç‰©çš„æœå‘å‘¢ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹ä¸€ä¸ªä¸­é—´ç‚¹çš„ä½ç½®ï¼Œè®©äººç‰©çœ‹å‘å®ƒå³å¯ã€‚
æ‰€ä»¥å›åˆ°ä¹‹å‰åˆå§‹åŒ–çš„åœ°æ–¹ï¼Œåˆ›å»ºä¸€ä¸ª `navigator`ã€‚
```
initCrowd() {
  // ...

  const navigator = MeshBuilder.CreateBox('navBall', {
    size: 0.1,
    height: 0.1,
  }, this.scene)
  navigator.isVisible = false
  this.navigator = navigator

  // ...
}
```

åœ¨ render çš„æ—¶å€™ï¼Œäººç‰©æ˜¯å¦åœæ­¢ï¼Œå¯ä»¥é€šè¿‡å½“å‰ `agent` çš„ç§»åŠ¨é€Ÿåº¦æ¥è¿›è¡Œåˆ¤æ–­ã€‚è€Œæ”¹å˜æ–¹å‘ï¼Œåˆ™æ˜¯é€šè¿‡å°† `navigator` ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª `path` çš„ä¸­é—´ç‚¹ï¼Œè®©äººç‰©çœ‹å‘å®ƒã€‚

```
onRender () {
  // ç¬¬ä¸€ä¸ªagentå¯¹è±¡çš„ç§»åŠ¨é€Ÿåº¦
  const velocity = this.crowd.getAgentVelocity(0)

  // ç§»åŠ¨äººç‰©åˆ°agentçš„ä½ç½®
  this.player.position = this.crowd.getAgentPosition(0)

  // å°†navigatorçš„ä½ç½®ç§»åˆ°ä¸‹ä¸€ä¸ªç‚¹
  this.crowd.getAgentNextTargetPathToRef(0, this.navigator.position)

  if (velocity.length() > 0) {
    this.player.lookAt(this.navigator.position)
    // ...
  } else {
    // ...
  }

 // ...
}
```

<br >


**4. é¿éšœå®ç°æ•ˆæœ**

è®©æˆ‘ä»¬çœ‹çœ‹æœ€åçš„æ•ˆæœ

![](https://storage.360buyimg.com/model-rendering-tool/sammy/obstacle-compress.gif)

<br >

**5. é‡åˆ°çš„é—®é¢˜**

æ•´ä¸ªå¼€å‘è¿‡ç¨‹ä¸­ï¼Œå…¶å®ä¹Ÿä¸æ˜¯éå¸¸é¡ºåˆ©ï¼Œæ€»ç»“äº†ä¸€äº›é‡åˆ°çš„é—®é¢˜ï¼Œå¯ä»¥ç»™å¤§å®¶å‚è€ƒä¸€ä¸‹ã€‚

(1) å¹´å…½ç§»åŠ¨æ—¶ï¼Œæœ‰æ—¶ä¼šâ€œæ— æ³•åˆ¹è½¦â€ï¼Œå¯¼è‡´åœ¨ç»ˆç‚¹æ—¶åå¤æ¥å›åœä¸ä¸‹æ¥ï¼›
è¿™æ˜¯å› ä¸ºåœ¨è¿™ä¸€å¸§é‡Œï¼Œç”±äºå¹´å…½çš„åŠ é€Ÿåº¦è¾ƒå°ï¼Œæ— æ³•ä½¿å¾—çŸ­æ—¶é—´å†…å°†é€Ÿåº¦é™ä¸º0ã€‚æ‰€ä»¥åªèƒ½â€œèµ°è¿‡å¤´â€å†â€œèµ°å›æ¥â€ç›´åˆ°é€Ÿåº¦é™ä¸º0ä¹‹åï¼Œåœæ­¢åœ¨ç»ˆç‚¹ã€‚
æ­¤æ—¶ï¼Œåªéœ€è¦ hack ä¸€ä¸‹ï¼Œå°† agent çš„ maxAcceleration è®¾ä¸ºæå¤§ï¼Œè®©å…¶æœ‰ç§åŒ€é€Ÿè¡Œèµ°å¹¶ç«‹é©¬åœä¸‹çš„æ„Ÿè§‰ã€‚
```
export const AGENTS_CONFIG: IAgentParameters = {
  maxAcceleration: 1000
  // ...
}
```

<br >

(2) éšœç¢ç‰©çš„åŠ¨æ€æ·»åŠ ä¸ç§»é™¤

å¦‚æœéšœç¢ç‰©åœ¨è¯¥åœºæ™¯åˆå§‹åŒ–åï¼Œä½ç½®å‘ç”Ÿäº†æ”¹å˜ï¼Œæ­¤æ—¶å†å»é”€æ¯åˆ›å»ºä¸€æ¬¡ navMesh æ˜¯å¾ˆæ¶ˆè€—æ€§èƒ½çš„ã€‚

äºæ˜¯æˆ‘ä»¬é€šè¿‡æŸ¥æ‰¾æ–‡æ¡£ï¼Œçœ‹åˆ°è¿˜æœ‰[åŠ¨æ€æ·»åŠ éšœç¢ç‰©](https://doc.babylonjs.com/extensions/crowdNavigation/obstacles)çš„ APIã€‚å†ç«‹é©¬è°ƒäº†ä¸‹[æ–‡æ¡£ä¸­çš„Playground](https://playground.babylonjs.com/#WCSDE1#25)ï¼Œå‘ç°æ˜¯å¯ä»¥ç”¨çš„ã€‚ä½†æ˜¯å½“æˆ‘ä»¬æŠŠéšœç¢ç‰©æ”¾å¤§äº†ä¹‹åï¼Œç©¿æ¨¡äº†ğŸ‘‰ [çœ‹çœ‹è¿™é‡Œ](https://playground.babylonjs.com/#WCSDE1#27)ã€‚

äºæ˜¯åœ¨ Babylon çš„è®ºå›ä¸Šæäº†[è¿™ä¸ªé—®é¢˜](https://forum.babylonjs.com/t/recastjsplugins-obstacles-api-fails-when-the-obstacle-is-big/28469)ï¼Œ20åˆ†é’Ÿåå°±å¾—åˆ°äº† replyï¼Œè¿™ä¸ªé€Ÿåº¦ğŸ‘ã€‚

åŸæ¥æ˜¯éœ€è¦è°ƒæ•´ `NavMeshParameters` çš„ `ch` / `cs` / `tileSize` å‚æ•°ï¼Œå¯¹é¡¹ç›®åšé€‚é…ã€‚

é‚£å¦‚æœæƒ³è¦è‡ªå·±å®ç°é¿éšœï¼Œåˆ›å»ºæ›´å¿«çš„navMeshï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š[3D æ²™ç›’æ¸¸æˆä¹‹é¿éšœè¸©å‘å’Œå®ç°ä¹‹æ—…](https://mp.weixin.qq.com/s/wqlUD6gQfnZGbpebSKcovg)

<br >

## æ€»ç»“
è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ä»éª¨éª¼åŠ¨ç”»çš„ä»‹ç»åŠä½¿ç”¨ã€æ¨¡å‹çš„ç§»åŠ¨åŠçŠ¶æ€æ”¹å˜ã€è·¯å¾„è§„åˆ’çš„é€‚é…ä¸‰ä¸ªæ–¹é¢ï¼Œè®²è§£äº†3Dæ²™ç›’æ¸¸æˆä¸­å®ç°äººç‰©è¡Œèµ°ç§»åŠ¨å¹¶è¿›è¡ŒçŠ¶æ€æ”¹å˜çš„æ€è·¯åŠæ­¥éª¤ï¼Œå¸Œæœ›æ–°äººé˜…è¯»ç»“æŸä¹‹åï¼Œèƒ½æ›´å¿«ä¸Šæ‰‹è¿™ä¸ªåŠŸèƒ½ã€‚

å½“ç„¶ï¼Œæœ¬ç¯‡æ–‡ç« ä»‹ç»çš„å®ç°æ–¹å¼è¿˜ä»æœ‰ä¸è¶³ä¹‹å¤„ï¼Œæ¯”å¦‚ç§»åŠ¨å¯ä»¥åŠ ä¸ŠåŠ é€Ÿåº¦ï¼Œè®©åŠ¨ä½œä¸ç§»åŠ¨é€Ÿåº¦åŒ¹é…å¾—æ›´è‡ªç„¶ç­‰ã€‚

å¦‚æœè¿˜æœ‰ä»€ä¹ˆåˆé€‚çš„å»ºè®®ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶ç§¯æç•™è¨€äº¤æµã€‚

<br >


## å‚è€ƒèµ„æ–™
1. [éª¨éª¼åŠ¨ç”» - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦](https://zh.wikipedia.org/wiki/%E9%AA%A8%E9%AA%BC%E5%8A%A8%E7%94%BB)
2. [Grouping Animations | Babylon.js Documentation](https://doc.babylonjs.com/divingDeeper/animation/groupAnimations)
3. [Advanced Animation Methods | Babylon.js Documentation](https://doc.babylonjs.com/divingDeeper/animation/advanced_animations)
4. [Vector3 | Babylon.js Documentation](https://doc.babylonjs.com/typedoc/classes/babylon.vector3)
5. [Crowd Navigation System | Babylon.js Documentation](https://doc.babylonjs.com/extensions/crowdNavigation)
6. [Web Workers API](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API)
7. [Make crowd agent move at constant speed - Questions - Babylon.js](https://forum.babylonjs.com/t/make-crowd-agent-move-at-constant-speed/19739)

